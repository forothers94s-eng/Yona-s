<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YONAçš„çµç®—è¨ˆç®—æ©Ÿ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Kiwi+Maru:wght@300;500&family=Noto+Sans+TC:wght@300;400;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg-color: #FDFBF7;       /* å¥¶æ²¹ç™½èƒŒæ™¯ */
            --card-bg: #FFF;           /* ç´”ç™½å¡ç‰‡ */
            --primary-color: #D4A373;  /* å¥¶èŒ¶è‰² */
            --accent-color: #CCD5AE;   /* é…ªæ¢¨ç¶  */
            --accent-hover: #E9EDC9;   
            --danger-color: #E74C3C;   /* è­¦å‘Šç´… */
            --text-color: #5D5C61;     /* æš–ç°æ–‡å­— */
            --border-radius: 16px;     
            --shadow: 0 4px 15px rgba(212, 163, 115, 0.15);
        }

        body { 
            font-family: 'Kiwi Maru', 'Noto Sans TC', sans-serif; 
            background-color: var(--bg-color); 
            color: var(--text-color); 
            padding: 20px; margin: 0;
        }

        .container { 
            max-width: 600px; margin: 0 auto; 
            background: var(--card-bg); padding: 30px; 
            border-radius: var(--border-radius); 
            box-shadow: var(--shadow); border: 2px solid #FAEDCD;
            position: relative;
        }

        /* æ¸…é™¤æŒ‰éˆ• (å³ä¸Šè§’) */
        .reset-btn-top {
            position: absolute; top: 20px; right: 20px;
            background: #FFE5E5; color: #C0392B;
            font-size: 12px; padding: 5px 10px; border-radius: 10px;
            cursor: pointer; border: 1px solid #FFCUCU;
        }
        .reset-btn-top:hover { background: #FFD0D0; }

        h1 { 
            text-align: center; color: var(--primary-color); 
            font-weight: 500; margin-bottom: 5px; font-size: 28px; margin-top: 10px;
        }
        
        h2, h3 { color: #8D7B68; font-weight: 500; margin-top: 0;}

        .section { 
            background: #FFFEFA; margin-bottom: 25px; padding: 20px; 
            border: 1px dashed #E0D5C1; border-radius: var(--border-radius); 
        }

        /* åŒ¯ç‡è¨­å®šå€ */
        .rate-settings {
            background-color: #FAF6F0; padding: 15px;
            border-radius: 12px; margin-bottom: 20px;
            border: 1px solid #E0D5C1;
        }
        .rate-row {
            display: flex; align-items: center; gap: 8px; flex-wrap: wrap; margin-top: 8px;
        }
        .bot-link {
            text-decoration: none; background: #947e68; color: white;
            padding: 4px 10px; border-radius: 8px; font-size: 12px;
            display: inline-block; transition: 0.3s;
        }
        .bot-link:hover { background: #7a6652; }

        /* è¼¸å…¥æ¡†èˆ‡æŒ‰éˆ• */
        input, select { 
            padding: 12px; border: 1px solid #E0D5C1; 
            border-radius: 10px; font-size: 15px; 
            background: #FFF; color: var(--text-color);
            outline: none; transition: 0.3s;
        }
        input:focus, select:focus { border-color: var(--primary-color); }

        .input-group { display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap;}
        .input-group input[type="text"] { flex: 2; }
        .input-group input[type="number"] { flex: 1; min-width: 80px;}

        button { 
            cursor: pointer; background-color: var(--accent-color); 
            color: #584B3D; border: none; border-radius: 20px;
            padding: 10px 20px; font-size: 15px; font-weight: bold;
            transition: 0.3s; font-family: 'Kiwi Maru', sans-serif;
        }
        button:hover { background-color: var(--accent-hover); transform: translateY(-2px); }
        
        button.action-btn { width: 100%; padding: 15px; background-color: var(--primary-color); color: white; font-size: 18px; margin-top: 10px; }
        button.download-btn { width: 100%; background-color: #A5A58D; color: white; margin-top: 10px; }
        button.delete-btn { background-color: #FFB7B2; color: white; padding: 5px 12px; font-size: 12px; border-radius: 10px;}

        /* å¤–å¹£é–‹é—œ */
        .currency-toggle {
            display: flex; align-items: center; margin-bottom: 10px;
            font-size: 14px; color: #8D7B68; cursor: pointer;
            background: #FFF9F0; padding: 8px; border-radius: 8px; width: fit-content;
        }
        .currency-toggle input { margin-right: 8px; transform: scale(1.2); }

        /* åƒèˆ‡è€… Checkbox */
        .participant-selector {
            display: flex; flex-wrap: wrap; gap: 10px; margin-top: 10px;
            background: #FAF6F0; padding: 10px; border-radius: 10px;
        }
        .checkbox-label {
            display: flex; align-items: center; cursor: pointer;
            font-size: 14px; background: white; padding: 5px 10px;
            border-radius: 15px; border: 1px solid #E0D5C1;
        }
        .checkbox-label input { margin-right: 5px; }

        /* è¡¨æ ¼ */
        table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 14px; }
        th { text-align: left; color: #8D7B68; padding: 8px; border-bottom: 2px solid #FAEDCD; }
        td { padding: 8px; border-bottom: 1px solid #F0E6D2; color: #666; }
        
        .sub-text { font-size: 12px; color: #999; display: block; margin-top: 2px;}
        .tag { display: inline-block; background: #FEFAE0; color: #8D7B68; padding: 4px 12px; border-radius: 20px; font-size: 13px; margin-right: 5px; margin-bottom: 5px;}

        /* çµæœå€å¡Š */
        .result-box {
            background-image: linear-gradient(to bottom right, #fff, #FFF9F0);
            padding: 20px; border-radius: var(--border-radius);
            margin-top: 20px; border: 2px solid #FAEDCD;
        }
        
        .transfer-item {
            background: #FFF; margin: 8px 0; padding: 12px;
            border-radius: 12px; border-left: 6px solid var(--primary-color);
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            display: flex; justify-content: space-between; align-items: center;
        }
        .amount-highlight { color: #D4A373; font-weight: bold; font-size: 1.1em; }
        .footer-note { text-align: center; font-size: 12px; color: #CCC; margin-top: 20px; }
    </style>
</head>
<body>

<div class="container">
    <button class="reset-btn-top" onclick="clearAllData()">ğŸ—‘ï¸ æ¸…é™¤æ‰€æœ‰ç´€éŒ„</button>

    <h1>âœˆï¸ YONAçš„åŒ¯ç‡çµç®—æ©Ÿ</h1>
    <p style="text-align: center; font-size: 14px; color: #999;">âœ¨ é—œæ‰è¦–çª—ä¹Ÿèƒ½è‡ªå‹•å­˜æª” âœ¨</p>

    <div class="rate-settings">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <span style="font-weight:bold; color:#8D7B68;">ğŸŒ åŒ¯ç‡è¨­å®š</span>
            <a href="https://rate.bot.com.tw/xrt?Lang=zh-TW" target="_blank" class="bot-link">ğŸ” æŸ¥è©¢å°éŠ€åŒ¯ç‡</a>
        </div>
        <div class="rate-row">
            <span>å¹£åˆ¥:</span>
            <input type="text" id="currencyName" value="JPY" placeholder="å¹£åˆ¥" style="width: 60px; text-align:center;" oninput="saveData()">
            <span>åŒ¯ç‡:</span>
            <input type="number" id="exchangeRate" value="0.22" step="0.0001" placeholder="åŒ¯ç‡" style="width: 80px;" oninput="saveData()">
            <span style="font-size:12px; color:#999;">(1å…ƒå¤–å¹£ = å¤šå°‘å°å¹£)</span>
        </div>
    </div>

    <div class="section">
        <h3>1. èª°ä¸€èµ·å‡ºå»ç©ï¼Ÿ</h3>
        <div class="input-group">
            <input type="text" id="newPersonName" placeholder="è¼¸å…¥æš±ç¨±...">
            <button onclick="addPerson()">ï¼‹ åŠ å…¥</button>
        </div>
        <div id="personList"></div>
    </div>

    <div class="section">
        <h3>2. è¨˜ä¸‹ä¸€ç­†æ¶ˆè²»</h3>
        <div class="input-group">
            <input type="text" id="itemName" placeholder="é …ç›® (ä¾‹: å±…é…’å±‹)">
            <input type="number" id="itemCost" placeholder="é‡‘é¡">
            <select id="payerSelect">
                <option value="" disabled selected>èª°å…ˆä»˜?</option>
            </select>
        </div>
        
        <label class="currency-toggle">
            <input type="checkbox" id="isForeignCurrency"> 
            æ˜¯ <span id="labelCurrencyName" style="color:#D4A373; font-weight:bold; margin:0 3px;">JPY</span> (å¤–å¹£) å—ï¼Ÿ
        </label>

        <div style="font-size: 14px; color: #8D7B68; margin-bottom: 5px; margin-top:15px;">ğŸ‘‡ èª°æœ‰åƒèˆ‡åˆ†æ”¤ï¼Ÿ(é è¨­å…¨å“¡)</div>
        <div id="involvedCheckboxes" class="participant-selector">
            <span style="color:#ccc; font-size:12px;">è«‹å…ˆæ–°å¢äººå“¡...</span>
        </div>

        <button onclick="addExpense()" style="width: 100%; margin-top: 10px; background-color: #D4A373; color: white;">ï¼‹ æ–°å¢é€™ç­†æ¶ˆè²»</button>

        <table id="expenseTable">
            <thead>
                <tr>
                    <th width="35%">é …ç›®</th>
                    <th width="20%">ä»£å¢Š</th>
                    <th width="25%">é‡‘é¡(å°å¹£)</th>
                    <th width="10%">åˆ†æ”¤</th>
                    <th width="10%"></th>
                </tr>
            </thead>
            <tbody id="expenseTableBody"></tbody>
        </table>
    </div>

    <button class="action-btn" onclick="calculate()">ğŸ€ ç”¢ç”Ÿçµç®—å ±å‘Š</button>

    <div id="reportSection" style="display:none;">
        <div class="result-box" id="resultCaptureTarget">
            <h2 style="text-align: center;">ğŸ“Š çµç®—çµæœ (TWD)</h2>
            <div style="display: flex; justify-content: space-around; margin-bottom: 15px; font-weight: bold; color: #8D7B68;">
                <span>ç¸½æ”¯å‡º: $<span id="totalDisplay">0</span></span>
            </div>

            <h3 style="font-size: 16px;">ğŸ’¸ è½‰å¸³å»ºè­° (å°å¹£)</h3>
            <div id="transferList"></div>

            <h3 style="font-size: 16px; margin-top: 20px;">ğŸ“‹ æ”¶æ”¯æ˜ç´°</h3>
            <table>
                <thead>
                    <tr>
                        <th>å§“å</th>
                        <th>å…ˆä»˜äº†</th>
                        <th>æ‡‰åˆ†æ”¤</th>
                        <th>æ·¨é¡</th>
                    </tr>
                </thead>
                <tbody id="balanceTableBody"></tbody>
            </table>
            <div class="footer-note">Generated by YONA Calculator</div>
        </div>
        
        <button class="download-btn" onclick="downloadImage()">ğŸ“¸ ä¸‹è¼‰çµæœåœ–ç‰‡</button>
    </div>
</div>

<script>
    let people = []; 
    let expenses = []; 

    // --- åˆå§‹åŒ–ï¼šè®€å–èˆŠè³‡æ–™ ---
    window.onload = function() {
        loadData();
    };

    // å„²å­˜è³‡æ–™åˆ° LocalStorage
    function saveData() {
        const currencyName = document.getElementById('currencyName').value;
        const exchangeRate = document.getElementById('exchangeRate').value;
        
        localStorage.setItem('yona_people', JSON.stringify(people));
        localStorage.setItem('yona_expenses', JSON.stringify(expenses));
        localStorage.setItem('yona_currencyName', currencyName);
        localStorage.setItem('yona_exchangeRate', exchangeRate);

        // æ›´æ–°å¤–å¹£æ¨™ç±¤é¡¯ç¤º
        document.getElementById('labelCurrencyName').innerText = currencyName || 'å¤–å¹£';
    }

    // è®€å–è³‡æ–™
    function loadData() {
        const storedPeople = localStorage.getItem('yona_people');
        const storedExpenses = localStorage.getItem('yona_expenses');
        const storedCurrency = localStorage.getItem('yona_currencyName');
        const storedRate = localStorage.getItem('yona_exchangeRate');

        if (storedPeople) people = JSON.parse(storedPeople);
        if (storedExpenses) expenses = JSON.parse(storedExpenses);
        
        if (storedCurrency) {
            document.getElementById('currencyName').value = storedCurrency;
            document.getElementById('labelCurrencyName').innerText = storedCurrency;
        }
        if (storedRate) document.getElementById('exchangeRate').value = storedRate;

        // æ¢å¾©ä»‹é¢
        updatePersonUI();
        renderExpenses();
    }

    // æ¸…é™¤æ‰€æœ‰è³‡æ–™
    function clearAllData() {
        if (confirm('ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰ç´€éŒ„å—ï¼Ÿ(äººå“¡å’Œå¸³å‹™éƒ½æœƒæ¶ˆå¤±å–”)')) {
            localStorage.clear();
            people = [];
            expenses = [];
            // é‡æ•´é é¢æœ€å¿«
            location.reload(); 
        }
    }

    // --- ä»¥ä¸‹ç‚ºåŸæœ‰åŠŸèƒ½ (å·²åŠ å…¥ saveData) ---

    // ç›£è½åŒ¯ç‡åç¨±è®Šæ›´
    document.getElementById('currencyName').addEventListener('input', function(e) {
        document.getElementById('labelCurrencyName').innerText = e.target.value || 'å¤–å¹£';
        saveData(); // å„²å­˜
    });

    function addPerson() {
        const nameInput = document.getElementById('newPersonName');
        const name = nameInput.value.trim();
        if (name && !people.includes(name)) {
            people.push(name);
            updatePersonUI();
            nameInput.value = '';
            saveData(); // å„²å­˜
        } else if (people.includes(name)) {
            alert('é€™å€‹åå­—å·²ç¶“æœ‰å›‰ï¼');
        }
    }

    function updatePersonUI() {
        document.getElementById('personList').innerHTML = people.map(p => `<span class="tag">${p}</span>`).join('');
        const select = document.getElementById('payerSelect');
        const currentVal = select.value;
        select.innerHTML = `<option value="" disabled selected>èª°å…ˆä»˜?</option>` + 
                           people.map(p => `<option value="${p}">${p}</option>`).join('');
        if (people.includes(currentVal)) select.value = currentVal;
        
        // ç‚ºäº†é¿å…å½±éŸ¿æ­£åœ¨è¼¸å…¥çš„ checkboxï¼Œæˆ‘å€‘åªåœ¨åˆå§‹åŒ–æˆ–æ–°å¢äººå“¡æ™‚é‡ç¹ªæ¯”è¼ƒå¥½
        // ä½†ç‚ºäº†ç°¡å–®èµ·è¦‹ï¼Œé€™è£¡é‚„æ˜¯æœƒé‡ç¹ªï¼Œä½¿ç”¨è€…æ–°å¢äººå“¡æ™‚è¦ç•™æ„
        renderCheckboxes(); 
    }

    function renderCheckboxes() {
        const container = document.getElementById('involvedCheckboxes');
        if(people.length === 0) {
            container.innerHTML = '<span style="color:#ccc; font-size:12px;">è«‹å…ˆæ–°å¢äººå“¡...</span>';
            return;
        }
        // è®€å–æ™‚ï¼Œé€™è£¡é è¨­ checked=trueï¼Œå¯èƒ½å°è‡´æ“ä½œä¸­çš„ç‹€æ…‹é‡ç½®ï¼Œ
        // ä½†å› ç‚ºæ˜¯ç°¡å–®æ‡‰ç”¨ï¼Œä¸”é€šå¸¸æ˜¯æ–°å¢äººå“¡å¾Œæ‰è¼¸å…¥æ¶ˆè²»ï¼Œæ•…å½±éŸ¿ä¸å¤§ã€‚
        // è‹¥è¦ä¿ç•™å‹¾é¸ç‹€æ…‹éœ€æ›´è¤‡é›œé‚è¼¯ï¼Œæ­¤è™•ä¿æŒ "æ–°å¢äººå“¡å¾Œé‡ç½®ç‚ºå…¨é¸"ã€‚
        container.innerHTML = people.map(p => `
            <label class="checkbox-label">
                <input type="checkbox" name="involved" value="${p}" checked> ${p}
            </label>
        `).join('');
    }

    function addExpense() {
        const item = document.getElementById('itemName').value.trim();
        let inputCost = parseFloat(document.getElementById('itemCost').value);
        const payer = document.getElementById('payerSelect').value;
        const isForeign = document.getElementById('isForeignCurrency').checked;
        const rate = parseFloat(document.getElementById('exchangeRate').value) || 1;
        const currencyName = document.getElementById('currencyName').value || 'å¤–å¹£';

        const checkboxes = document.querySelectorAll('input[name="involved"]:checked');
        const involved = Array.from(checkboxes).map(cb => cb.value);

        if (!item || isNaN(inputCost) || !payer) { alert('è«‹å¡«å¯«å®Œæ•´ï¼šé …ç›®ã€é‡‘é¡ã€ä»˜æ¬¾äºº'); return; }
        if (involved.length === 0) { alert('è‡³å°‘è¦æœ‰ä¸€å€‹äººåˆ†æ”¤é€™ç­†è²»ç”¨å–”ï¼'); return; }

        let finalCostTWD = isForeign ? Math.round(inputCost * rate) : inputCost;

        expenses.push({ 
            item, inputCost, cost: finalCostTWD, payer, involved, isForeign, currencyName
        });
        
        renderExpenses();
        saveData(); // å„²å­˜

        // æ¸…ç©ºè¼¸å…¥
        document.getElementById('itemName').value = '';
        document.getElementById('itemCost').value = '';
        document.querySelectorAll('input[name="involved"]').forEach(cb => cb.checked = true);
        document.getElementById('isForeignCurrency').checked = false;
    }

    function renderExpenses() {
        const tbody = document.getElementById('expenseTableBody');
        tbody.innerHTML = expenses.map((ex, index) => {
            let displayAmount = `$${ex.cost}`;
            if (ex.isForeign) {
                displayAmount = `<span style="font-weight:bold; color:#D4A373">$${ex.cost}</span>
                                 <span class="sub-text">(${ex.currencyName} ${ex.inputCost})</span>`;
            }

            return `<tr>
                <td>${ex.item}</td>
                <td>${ex.payer}</td>
                <td>${displayAmount}</td>
                <td style="font-size:12px; color:#999;">${ex.involved.length === people.length ? 'å…¨å“¡' : ex.involved.length + 'äºº'}</td>
                <td><button class="delete-btn" onclick="removeExpense(${index})">âœ•</button></td>
            </tr>`;
        }).join('');
    }

    function removeExpense(index) {
        expenses.splice(index, 1);
        renderExpenses();
        saveData(); // å„²å­˜
    }

    function calculate() {
        if (people.length === 0) { alert("é‚„æ²’æœ‰äººå–”ï¼"); return; }
        if (expenses.length === 0) { alert("é‚„æ²’æœ‰æ¶ˆè²»ç´€éŒ„ï¼"); return; }

        let total = 0;
        let paidMap = {}; let shouldPayMap = {}; 
        people.forEach(p => { paidMap[p] = 0; shouldPayMap[p] = 0; });

        expenses.forEach(ex => {
            total += ex.cost;
            if (paidMap[ex.payer] !== undefined) paidMap[ex.payer] += ex.cost;
            let splitAmount = ex.cost / ex.involved.length;
            ex.involved.forEach(person => {
                if (shouldPayMap[person] !== undefined) shouldPayMap[person] += splitAmount;
            });
        });

        let balances = [];
        people.forEach(p => {
            let balance = paidMap[p] - shouldPayMap[p];
            balances.push({ name: p, paid: paidMap[p], shouldPay: shouldPayMap[p], balance: balance });
        });

        document.getElementById('reportSection').style.display = 'block';
        document.getElementById('totalDisplay').innerText = total;

        const balanceTbody = document.getElementById('balanceTableBody');
        balanceTbody.innerHTML = balances.map(b => `
            <tr>
                <td>${b.name}</td>
                <td>${Math.round(b.paid)}</td>
                <td>${Math.round(b.shouldPay)}</td>
                <td style="color:${b.balance >= 0 ? '#6B8E23' : '#E74C3c'}; font-weight:bold;">
                    ${b.balance >= 0 ? `+${Math.round(b.balance)}` : `${Math.round(b.balance)}`}
                </td>
            </tr>
        `).join('');

        let debtors = balances.filter(b => b.balance < -0.5).sort((a, b) => a.balance - b.balance);
        let creditors = balances.filter(b => b.balance > 0.5).sort((a, b) => b.balance - a.balance);
        let transactions = [];
        let i = 0; let j = 0;

        while (i < debtors.length && j < creditors.length) {
            let debtor = debtors[i];
            let creditor = creditors[j];
            let amount = Math.min(Math.abs(debtor.balance), creditor.balance);
            
            transactions.push({ from: debtor.name, to: creditor.name, amount: amount });
            debtor.balance += amount; creditor.balance -= amount;
            if (Math.abs(debtor.balance) < 0.5) i++;
            if (creditor.balance < 0.5) j++;
        }

        const transferList = document.getElementById('transferList');
        if (transactions.length > 0) {
            transferList.innerHTML = transactions.map(t => `
                <div class="transfer-item">
                    <span>${t.from} <span style="font-size:12px; color:#999;">çµ¦</span> ${t.to}</span>
                    <span class="amount-highlight">$${Math.round(t.amount)}</span>
                </div>
            `).join('');
        } else {
            transferList.innerHTML = `<div style="text-align:center; padding:10px;">ğŸ‰ å¸³ç›®å·²å¹³ï¼Œç„¡éœ€è½‰å¸³</div>`;
        }
        
        // é€™è£¡ä¸éœ€è¦ saveDataï¼Œå› ç‚ºè¨ˆç®—çµæœæ˜¯å‹•æ…‹ç”Ÿæˆçš„ï¼Œä¸æ˜¯è¼¸å…¥è³‡æ–™
    }

    function downloadImage() {
        const element = document.getElementById("resultCaptureTarget"); 
        html2canvas(element, {
            scale: 2, backgroundColor: "#FFF9F0", useCORS: true
        }).then(canvas => {
            let link = document.createElement('a');
            link.download = 'YONAçµç®—çµæœ.png';
            link.href = canvas.toDataURL("image/png");
            link.click();
        });
    }
</script>
</body>
</html>
