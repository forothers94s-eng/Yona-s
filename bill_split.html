<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åœ˜é«”æ—…éŠ/èšé¤ åˆ†å¸³çµç®—å ±å‘Š</title>
    <style>
        body { font-family: "Microsoft JhengHei", Arial, sans-serif; background-color: #f4f4f9; color: #333; padding: 20px; line-height: 1.6; }
        .container { max-width: 800px; margin: 0 auto; background: #fff; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1, h2 { text-align: center; color: #2c3e50; }
        .section { margin-bottom: 30px; padding: 15px; border: 1px solid #eee; border-radius: 8px; }
        .input-group { margin-bottom: 10px; display: flex; gap: 10px; flex-wrap: wrap; }
        input, select, button { padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 16px; }
        input[type="number"] { width: 100px; }
        button { cursor: pointer; background-color: #3498db; color: white; border: none; transition: 0.3s; }
        button:hover { background-color: #2980b9; }
        button.delete-btn { background-color: #e74c3c; padding: 5px 10px; font-size: 14px; }
        button.delete-btn:hover { background-color: #c0392b; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { padding: 10px; text-align: center; border-bottom: 1px solid #eee; }
        th { background-color: #f8f9fa; font-weight: bold; }
        
        .result-box { background-color: #e8f6f3; border-left: 5px solid #1abc9c; padding: 15px; margin-top: 20px; }
        .transfer-list { list-style: none; padding: 0; }
        .transfer-list li { background: #fff; margin: 5px 0; padding: 10px; border-radius: 5px; border-left: 5px solid #e67e22; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        
        .summary-highlight { font-weight: bold; color: #e74c3c; }
        .tag { display: inline-block; background: #eee; padding: 2px 8px; border-radius: 12px; font-size: 12px; margin-right: 5px;}
    </style>
</head>
<body>

<div class="container">
    <h1>ğŸ“ åœ˜é«”åˆ†å¸³çµç®—å ±å‘Š</h1>

    <div class="section">
        <h3>1. åƒèˆ‡äººå“¡ (è«‹å…ˆè¨­å®š)</h3>
        <div class="input-group">
            <input type="text" id="newPersonName" placeholder="è¼¸å…¥åå­— (å¦‚: A, B...)">
            <button onclick="addPerson()">æ–°å¢äººå“¡</button>
        </div>
        <div id="personList" style="margin-top: 10px;">
            </div>
    </div>

    <div class="section">
        <h3>2. æ–°å¢æ¶ˆè²»æ˜ç´°</h3>
        <div class="input-group">
            <input type="text" id="itemName" placeholder="æ¶ˆè²»é …ç›® (å¦‚: æ™šé¤)" style="flex: 2;">
            <input type="number" id="itemCost" placeholder="é‡‘é¡" style="flex: 1;">
            <select id="payerSelect" style="flex: 1;">
                <option value="" disabled selected>èª°ä»˜æ¬¾?</option>
            </select>
            <button onclick="addExpense()">åŠ å…¥æ˜ç´°</button>
        </div>

        <table>
            <thead>
                <tr>
                    <th>é …ç›®</th>
                    <th>ä»˜æ¬¾äºº</th>
                    <th>é‡‘é¡</th>
                    <th>æ“ä½œ</th>
                </tr>
            </thead>
            <tbody id="expenseTableBody">
                </tbody>
        </table>
    </div>

    <div style="text-align: center;">
        <button onclick="calculate()" style="width: 100%; padding: 15px; font-size: 18px; background-color: #27ae60;">ğŸ“Š ç”¢ç”Ÿçµç®—å ±å‘Š</button>
    </div>

    <div id="reportSection" class="section" style="display:none; margin-top: 20px;">
        <h2>çµç®—çµæœ</h2>
        
        <p><strong>ç¸½æ¶ˆè²»é‡‘é¡ï¼š</strong> <span id="totalDisplay">0</span> å…ƒ</p>
        <p><strong>ç¸½äººæ•¸ï¼š</strong> <span id="countDisplay">0</span> äºº</p>
        <p><strong>å¹³å‡æ¯äººæ‡‰åˆ†æ”¤ï¼š</strong> <span id="averageDisplay" class="summary-highlight">0</span> å…ƒ</p>

        <h3>ğŸ’° æœ€çµ‚è½‰å¸³å»ºè­° (èª°è©²çµ¦èª°å¤šå°‘éŒ¢)</h3>
        <ul id="transferList" class="transfer-list">
            </ul>

        <h3>ğŸ“‰ å€‹äººæ”¶æ”¯è©³æƒ…</h3>
        <table id="balanceTable">
            <thead>
                <tr>
                    <th>å§“å</th>
                    <th>å¯¦éš›å·²ä»˜</th>
                    <th>æ‡‰ä»˜ä»½é¡</th>
                    <th>æ·¨é¡ (å¤šä»˜/å°‘ä»˜)</th>
                </tr>
            </thead>
            <tbody id="balanceTableBody">
            </tbody>
        </table>
    </div>
</div>

<script>
    let people = []; // å„²å­˜äººå
    let expenses = []; // å„²å­˜æ¶ˆè²»ç´€éŒ„ {item, cost, payer}

    // æ–°å¢äººå“¡
    function addPerson() {
        const nameInput = document.getElementById('newPersonName');
        const name = nameInput.value.trim();
        if (name && !people.includes(name)) {
            people.push(name);
            updatePersonUI();
            nameInput.value = '';
        } else if (people.includes(name)) {
            alert('é€™å€‹åå­—å·²ç¶“å­˜åœ¨å›‰ï¼');
        }
    }

    // æ›´æ–°äººå“¡é¡¯ç¤ºèˆ‡ä¸‹æ‹‰é¸å–®
    function updatePersonUI() {
        const list = document.getElementById('personList');
        const select = document.getElementById('payerSelect');
        
        list.innerHTML = people.map(p => `<span class="tag">${p}</span>`).join('');
        
        // ä¿å­˜ç•¶å‰é¸ä¸­çš„å€¼
        const currentVal = select.value;
        select.innerHTML = `<option value="" disabled selected>èª°ä»˜æ¬¾?</option>` + 
                           people.map(p => `<option value="${p}">${p}</option>`).join('');
        if (people.includes(currentVal)) select.value = currentVal;
    }

    // æ–°å¢æ¶ˆè²»
    function addExpense() {
        const item = document.getElementById('itemName').value.trim();
        const cost = parseFloat(document.getElementById('itemCost').value);
        const payer = document.getElementById('payerSelect').value;

        if (!item || isNaN(cost) || !payer) {
            alert('è«‹å®Œæ•´å¡«å¯«é …ç›®ã€é‡‘é¡ä¸¦é¸æ“‡ä»˜æ¬¾äºº');
            return;
        }

        expenses.push({ item, cost, payer });
        renderExpenses();
        
        // æ¸…ç©ºè¼¸å…¥
        document.getElementById('itemName').value = '';
        document.getElementById('itemCost').value = '';
    }

    // æ¸²æŸ“æ¶ˆè²»åˆ—è¡¨
    function renderExpenses() {
        const tbody = document.getElementById('expenseTableBody');
        tbody.innerHTML = expenses.map((ex, index) => `
            <tr>
                <td>${ex.item}</td>
                <td>${ex.payer}</td>
                <td>${ex.cost}</td>
                <td><button class="delete-btn" onclick="removeExpense(${index})">åˆªé™¤</button></td>
            </tr>
        `).join('');
    }

    // åˆªé™¤æ¶ˆè²»
    function removeExpense(index) {
        expenses.splice(index, 1);
        renderExpenses();
    }

    // --- æ ¸å¿ƒç®—æ³• ---
    function calculate() {
        if (people.length === 0) { alert("è«‹å…ˆæ–°å¢äººå“¡ï¼"); return; }
        if (expenses.length === 0) { alert("æ²’æœ‰æ¶ˆè²»ç´€éŒ„å¯ä»¥è¨ˆç®—ï¼"); return; }

        let total = 0;
        let paidMap = {}; // æ¯å€‹äººå¯¦éš›ä»˜äº†å¤šå°‘
        people.forEach(p => paidMap[p] = 0);

        // 1. çµ±è¨ˆç¸½é‡‘é¡èˆ‡æ¯äººå·²ä»˜é‡‘é¡
        expenses.forEach(ex => {
            total += ex.cost;
            if (paidMap[ex.payer] !== undefined) {
                paidMap[ex.payer] += ex.cost;
            }
        });

        // 2. è¨ˆç®—å¹³å‡
        let average = total / people.length;
        
        // 3. è¨ˆç®—æ·¨é¡ (Balance)
        let balances = [];
        people.forEach(p => {
            let paid = paidMap[p];
            let balance = paid - average; // æ­£æ•¸ä»£è¡¨å¤šä»˜(æ‡‰æ”¶éŒ¢)ï¼Œè² æ•¸ä»£è¡¨å°‘ä»˜(æ‡‰çµ¦éŒ¢)
            balances.push({ name: p, paid: paid, balance: balance });
        });

        // é¡¯ç¤ºçµ±è¨ˆæ•¸æ“š
        document.getElementById('reportSection').style.display = 'block';
        document.getElementById('totalDisplay').innerText = total;
        document.getElementById('countDisplay').innerText = people.length;
        document.getElementById('averageDisplay').innerText = average.toFixed(1); // é¡¯ç¤ºå°æ•¸é»å¾Œä¸€ä½

        // é¡¯ç¤ºå€‹äººè©³æƒ…è¡¨
        const balanceTbody = document.getElementById('balanceTableBody');
        balanceTbody.innerHTML = balances.map(b => `
            <tr>
                <td>${b.name}</td>
                <td>${b.paid}</td>
                <td>${average.toFixed(1)}</td>
                <td style="color:${b.balance >= 0 ? 'green' : 'red'}">
                    ${b.balance >= 0 ? `+${b.balance.toFixed(1)} (æ‡‰æ”¶)` : `${b.balance.toFixed(1)} (æ‡‰ä»˜)`}
                </td>
            </tr>
        `).join('');

        // 4. è¨ˆç®—è½‰å¸³è·¯å¾‘ (Greedy Algorithm)
        // å°‡äººåˆ†ç‚ºå…©çµ„ï¼šå‚µå‹™äºº (Debtors, balance < 0) å’Œ å‚µæ¬Šäºº (Creditors, balance > 0)
        let debtors = balances.filter(b => b.balance < -0.01).sort((a, b) => a.balance - b.balance);
        let creditors = balances.filter(b => b.balance > 0.01).sort((a, b) => b.balance - a.balance);
        
        let transactions = [];

        let i = 0; // index for debtors
        let j = 0; // index for creditors

        while (i < debtors.length && j < creditors.length) {
            let debtor = debtors[i];
            let creditor = creditors[j];

            // å–å…©è€…çµ•å°å€¼çš„è¼ƒå°è€…ä½œç‚ºäº¤æ˜“é‡‘é¡
            let amount = Math.min(Math.abs(debtor.balance), creditor.balance);
            
            // è¨˜éŒ„äº¤æ˜“
            transactions.push(`${debtor.name} æ‡‰è©²çµ¦ ${creditor.name}ï¼š ${amount.toFixed(0)} å…ƒ`);

            // æ›´æ–°é¤˜é¡
            debtor.balance += amount;
            creditor.balance -= amount;

            // å¦‚æœæŸä¸€æ–¹çµæ¸…äº†ï¼Œç§»å‹•æŒ‡æ¨™
            if (Math.abs(debtor.balance) < 0.01) i++;
            if (creditor.balance < 0.01) j++;
        }

        // é¡¯ç¤ºè½‰å¸³å»ºè­°
        const transferList = document.getElementById('transferList');
        if (transactions.length > 0) {
            transferList.innerHTML = transactions.map(t => `<li>${t}</li>`).join('');
        } else {
            transferList.innerHTML = `<li>ğŸ‰ å¸³ç›®å·²ç¶“å¹³è¡¡ï¼Œä¸éœ€è¦è½‰å¸³ï¼</li>`;
        }
    }

    // åˆå§‹åŒ–ç¯„ä¾‹æ•¸æ“š (ä¾æ“šä½¿ç”¨è€…é¡Œç›®)
    function initDemo() {
        // è‡ªå‹•å¡«å…¥ä½¿ç”¨è€…çš„ç¯„ä¾‹ A, B, C, D
        ['A', 'B', 'C', 'D'].forEach(n => {
            people.push(n);
        });
        updatePersonUI();
        
        // æ¨¡æ“¬æ¶ˆè²»
        expenses.push({ item: 'ç¯„ä¾‹æ¶ˆè²»1', cost: 600, payer: 'A' });
        expenses.push({ item: 'ç¯„ä¾‹æ¶ˆè²»2', cost: 400, payer: 'B' });
        renderExpenses();

        // é è¨­åŸ·è¡Œä¸€æ¬¡è¨ˆç®—
        calculate();
    }

    // è§£é™¤è¨»è§£ä¸‹é¢é€™è¡Œå¯ä»¥è‡ªå‹•è¼‰å…¥ç¯„ä¾‹æ•¸æ“š
    // window.onload = initDemo;

</script>

</body>
</html>
