<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YONAçš„çµç®—è¨ˆç®—æ©Ÿ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Kiwi+Maru:wght@300;500&family=Noto+Sans+TC:wght@300;400;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg-color: #FDFBF7;       /* å¥¶æ²¹ç™½èƒŒæ™¯ */
            --card-bg: #FFF;           /* ç´”ç™½å¡ç‰‡ */
            --primary-color: #D4A373;  /* å¥¶èŒ¶è‰² */
            --accent-color: #CCD5AE;   /* é…ªæ¢¨ç¶  (æŒ‰éˆ•) */
            --accent-hover: #E9EDC9;   /* æ·ºç¶  (Hover) */
            --text-color: #5D5C61;     /* æš–ç°æ–‡å­— */
            --border-radius: 16px;     /* åœ“è§’ */
            --shadow: 0 4px 15px rgba(212, 163, 115, 0.15);
        }

        body { 
            font-family: 'Kiwi Maru', 'Noto Sans TC', sans-serif; 
            background-color: var(--bg-color); 
            color: var(--text-color); 
            padding: 20px; 
            margin: 0;
        }

        .container { 
            max-width: 600px; 
            margin: 0 auto; 
            background: var(--card-bg); 
            padding: 30px; 
            border-radius: var(--border-radius); 
            box-shadow: var(--shadow); 
            border: 2px solid #FAEDCD;
        }

        h1 { 
            text-align: center; 
            color: var(--primary-color); 
            font-weight: 500; 
            margin-bottom: 10px;
            font-size: 28px;
        }
        
        h2, h3 { color: #8D7B68; font-weight: 500; margin-top: 0;}

        .section { 
            background: #FFFEFA;
            margin-bottom: 25px; 
            padding: 20px; 
            border: 1px dashed #E0D5C1; 
            border-radius: var(--border-radius); 
        }

        /* è¼¸å…¥æ¡†èˆ‡æŒ‰éˆ•æ¨£å¼ */
        input, select { 
            padding: 12px; 
            border: 1px solid #E0D5C1; 
            border-radius: 10px; 
            font-size: 15px; 
            background: #FFF;
            color: var(--text-color);
            outline: none;
            transition: 0.3s;
        }
        input:focus, select:focus { border-color: var(--primary-color); }

        .input-group { display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap;}
        .input-group input[type="text"] { flex: 2; }
        .input-group input[type="number"] { flex: 1; min-width: 80px;}

        button { 
            cursor: pointer; 
            background-color: var(--accent-color); 
            color: #584B3D; 
            border: none; 
            border-radius: 20px;
            padding: 10px 20px;
            font-size: 15px; 
            font-weight: bold;
            transition: 0.3s;
            font-family: 'Kiwi Maru', sans-serif;
        }
        button:hover { background-color: var(--accent-hover); transform: translateY(-2px); }
        
        button.action-btn { width: 100%; padding: 15px; background-color: var(--primary-color); color: white; font-size: 18px; margin-top: 10px; }
        button.download-btn { width: 100%; background-color: #A5A58D; color: white; margin-top: 10px; }
        button.delete-btn { background-color: #FFB7B2; color: white; padding: 5px 12px; font-size: 12px; border-radius: 10px;}

        /* åƒèˆ‡è€…é¸å–® Checkbox */
        .participant-selector {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
            background: #FAF6F0;
            padding: 10px;
            border-radius: 10px;
        }
        .checkbox-label {
            display: flex;
            align-items: center;
            cursor: pointer;
            font-size: 14px;
            background: white;
            padding: 5px 10px;
            border-radius: 15px;
            border: 1px solid #E0D5C1;
        }
        .checkbox-label input { margin-right: 5px; }

        /* è¡¨æ ¼æ¨£å¼ */
        table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 14px; }
        th { text-align: left; color: #8D7B68; padding: 8px; border-bottom: 2px solid #FAEDCD; }
        td { padding: 8px; border-bottom: 1px solid #F0E6D2; color: #666; }
        
        /* æ¨™ç±¤æ¨£å¼ */
        .tag { display: inline-block; background: #FEFAE0; color: #8D7B68; padding: 4px 12px; border-radius: 20px; font-size: 13px; margin-right: 5px; margin-bottom: 5px;}

        /* çµæœå€å¡Š */
        .result-box {
            background-image: linear-gradient(to bottom right, #fff, #FFF9F0);
            padding: 20px;
            border-radius: var(--border-radius);
            margin-top: 20px;
            border: 2px solid #FAEDCD;
        }
        
        .transfer-item {
            background: #FFF;
            margin: 8px 0;
            padding: 12px;
            border-radius: 12px;
            border-left: 6px solid var(--primary-color);
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .amount-highlight { color: #D4A373; font-weight: bold; font-size: 1.1em; }

        /* æµ®æ°´å° */
        .footer-note { text-align: center; font-size: 12px; color: #CCC; margin-top: 20px; }
    </style>
</head>
<body>

<div class="container">
    <h1>â˜ï¸ YONAçš„çµç®—è¨ˆç®—æ©Ÿ</h1>
    <p style="text-align: center; font-size: 14px; color: #999;">âœ¨ è¼•é¬†åˆ†å¸³ï¼Œæ„Ÿæƒ…ä¸æ•£ âœ¨</p>

    <div class="section">
        <h3>1. èª°ä¸€èµ·å‡ºå»ç©ï¼Ÿ</h3>
        <div class="input-group">
            <input type="text" id="newPersonName" placeholder="è¼¸å…¥æš±ç¨±...">
            <button onclick="addPerson()">ï¼‹ åŠ å…¥</button>
        </div>
        <div id="personList">
            </div>
    </div>

    <div class="section">
        <h3>2. è¨˜ä¸‹ä¸€ç­†æ¶ˆè²»</h3>
        <div class="input-group">
            <input type="text" id="itemName" placeholder="é …ç›® (ä¾‹: æ™šé¤)">
            <input type="number" id="itemCost" placeholder="$ é‡‘é¡">
            <select id="payerSelect">
                <option value="" disabled selected>èª°å…ˆä»˜?</option>
            </select>
        </div>
        
        <div style="font-size: 14px; color: #8D7B68; margin-bottom: 5px;">ğŸ‘‡ èª°æœ‰åƒèˆ‡åˆ†æ”¤ï¼Ÿ(é è¨­å…¨å“¡)</div>
        <div id="involvedCheckboxes" class="participant-selector">
            <span style="color:#ccc; font-size:12px;">è«‹å…ˆæ–°å¢äººå“¡...</span>
        </div>

        <button onclick="addExpense()" style="width: 100%; margin-top: 10px; background-color: #D4A373; color: white;">ï¼‹ æ–°å¢é€™ç­†æ¶ˆè²»</button>

        <table id="expenseTable">
            <thead>
                <tr>
                    <th width="30%">é …ç›®</th>
                    <th width="20%">ä»£å¢Š</th>
                    <th width="20%">é‡‘é¡</th>
                    <th width="15%">åˆ†æ”¤äººæ•¸</th>
                    <th width="15%"></th>
                </tr>
            </thead>
            <tbody id="expenseTableBody"></tbody>
        </table>
    </div>

    <button class="action-btn" onclick="calculate()">ğŸ€ ç”¢ç”Ÿçµç®—å ±å‘Š</button>

    <div id="reportSection" style="display:none;">
        <div class="result-box" id="resultCaptureTarget">
            <h2 style="text-align: center;">ğŸ“Š çµç®—çµæœ</h2>
            <div style="display: flex; justify-content: space-around; margin-bottom: 15px; font-weight: bold; color: #8D7B68;">
                <span>ç¸½æ”¯å‡º: $<span id="totalDisplay">0</span></span>
            </div>

            <h3 style="font-size: 16px;">ğŸ’¸ è½‰å¸³å»ºè­°</h3>
            <div id="transferList"></div>

            <h3 style="font-size: 16px; margin-top: 20px;">ğŸ“‹ æ”¶æ”¯æ˜ç´°</h3>
            <table>
                <thead>
                    <tr>
                        <th>å§“å</th>
                        <th>å…ˆä»˜äº†</th>
                        <th>æ‡‰åˆ†æ”¤</th>
                        <th>æ·¨é¡</th>
                    </tr>
                </thead>
                <tbody id="balanceTableBody"></tbody>
            </table>
            <div class="footer-note">Generated by YONA Calculator</div>
        </div>
        
        <button class="download-btn" onclick="downloadImage()">ğŸ“¸ ä¸‹è¼‰åœ–ç‰‡ (åˆ†äº«åˆ°ç¾¤çµ„)</button>
    </div>
</div>

<script>
    let people = []; 
    let expenses = []; 

    // æ–°å¢äººå“¡
    function addPerson() {
        const nameInput = document.getElementById('newPersonName');
        const name = nameInput.value.trim();
        if (name && !people.includes(name)) {
            people.push(name);
            updatePersonUI();
            nameInput.value = '';
        } else if (people.includes(name)) {
            alert('é€™å€‹åå­—å·²ç¶“æœ‰å›‰ï¼');
        }
    }

    // æ›´æ–°ä»‹é¢ (æ¨™ç±¤ã€ä¸‹æ‹‰é¸å–®ã€æ ¸å–æ–¹å¡Š)
    function updatePersonUI() {
        // 1. åˆ—è¡¨
        document.getElementById('personList').innerHTML = people.map(p => `<span class="tag">${p}</span>`).join('');
        
        // 2. ä»˜æ¬¾äººä¸‹æ‹‰
        const select = document.getElementById('payerSelect');
        const currentVal = select.value;
        select.innerHTML = `<option value="" disabled selected>èª°å…ˆä»˜?</option>` + 
                           people.map(p => `<option value="${p}">${p}</option>`).join('');
        if (people.includes(currentVal)) select.value = currentVal;

        // 3. åƒèˆ‡åˆ†æ”¤ Checkbox
        renderCheckboxes();
    }

    function renderCheckboxes() {
        const container = document.getElementById('involvedCheckboxes');
        if(people.length === 0) {
            container.innerHTML = '<span style="color:#ccc; font-size:12px;">è«‹å…ˆæ–°å¢äººå“¡...</span>';
            return;
        }
        
        // ç°¡å–®é‡ç¹ªï¼Œé è¨­å…¨é¸
        container.innerHTML = people.map(p => `
            <label class="checkbox-label">
                <input type="checkbox" name="involved" value="${p}" checked> ${p}
            </label>
        `).join('');
    }

    // æ–°å¢æ¶ˆè²»
    function addExpense() {
        const item = document.getElementById('itemName').value.trim();
        const cost = parseFloat(document.getElementById('itemCost').value);
        const payer = document.getElementById('payerSelect').value;
        
        // ç²å–è¢«å‹¾é¸çš„åƒèˆ‡äºº
        const checkboxes = document.querySelectorAll('input[name="involved"]:checked');
        const involved = Array.from(checkboxes).map(cb => cb.value);

        if (!item || isNaN(cost) || !payer) {
            alert('è«‹å¡«å¯«å®Œæ•´ï¼šé …ç›®ã€é‡‘é¡ã€ä»˜æ¬¾äºº');
            return;
        }
        if (involved.length === 0) {
            alert('è‡³å°‘è¦æœ‰ä¸€å€‹äººåˆ†æ”¤é€™ç­†è²»ç”¨å–”ï¼');
            return;
        }

        expenses.push({ item, cost, payer, involved });
        renderExpenses();
        
        // æ¸…ç©ºè¼¸å…¥
        document.getElementById('itemName').value = '';
        document.getElementById('itemCost').value = '';
        // æ¢å¾©å…¨é¸
        document.querySelectorAll('input[name="involved"]').forEach(cb => cb.checked = true);
    }

    function renderExpenses() {
        const tbody = document.getElementById('expenseTableBody');
        tbody.innerHTML = expenses.map((ex, index) => `
            <tr>
                <td>${ex.item}</td>
                <td>${ex.payer}</td>
                <td>${ex.cost}</td>
                <td style="font-size:12px; color:#999;">${ex.involved.length === people.length ? 'å…¨å“¡' : ex.involved.join(', ')}</td>
                <td><button class="delete-btn" onclick="removeExpense(${index})">âœ•</button></td>
            </tr>
        `).join('');
    }

    function removeExpense(index) {
        expenses.splice(index, 1);
        renderExpenses();
    }

    // --- è¨ˆç®—é‚è¼¯ (æ”¯æ´æ’é™¤äººå“¡) ---
    function calculate() {
        if (people.length === 0) { alert("é‚„æ²’æœ‰äººå–”ï¼"); return; }
        if (expenses.length === 0) { alert("é‚„æ²’æœ‰æ¶ˆè²»ç´€éŒ„ï¼"); return; }

        let total = 0;
        let paidMap = {};      // å¯¦éš›ä»˜å‡ºçš„éŒ¢
        let shouldPayMap = {}; // æ‡‰è©²ä»˜çš„éŒ¢ (æ¶ˆè²»é¡)
        
        people.forEach(p => {
            paidMap[p] = 0;
            shouldPayMap[p] = 0;
        });

        // éæ­·æ¯ä¸€ç­†æ¶ˆè²»
        expenses.forEach(ex => {
            total += ex.cost;
            
            // è¨˜éŒ„èª°å…ˆä»˜éŒ¢
            if (paidMap[ex.payer] !== undefined) {
                paidMap[ex.payer] += ex.cost;
            }

            // è¨ˆç®—åˆ†æ”¤ (é‡‘é¡ / åƒèˆ‡äººæ•¸)
            let splitAmount = ex.cost / ex.involved.length;
            ex.involved.forEach(person => {
                if (shouldPayMap[person] !== undefined) {
                    shouldPayMap[person] += splitAmount;
                }
            });
        });

        // è¨ˆç®—æ·¨é¡ (å·²ä»˜ - æ‡‰ä»˜)
        let balances = [];
        people.forEach(p => {
            let balance = paidMap[p] - shouldPayMap[p];
            balances.push({ name: p, paid: paidMap[p], shouldPay: shouldPayMap[p], balance: balance });
        });

        // é¡¯ç¤ºä»‹é¢
        document.getElementById('reportSection').style.display = 'block';
        document.getElementById('totalDisplay').innerText = total;

        // è¡¨æ ¼
        const balanceTbody = document.getElementById('balanceTableBody');
        balanceTbody.innerHTML = balances.map(b => `
            <tr>
                <td>${b.name}</td>
                <td>${b.paid}</td>
                <td>${b.shouldPay.toFixed(1)}</td>
                <td style="color:${b.balance >= 0 ? '#6B8E23' : '#E74C3c'}; font-weight:bold;">
                    ${b.balance >= 0 ? `+${b.balance.toFixed(0)}` : `${b.balance.toFixed(0)}`}
                </td>
            </tr>
        `).join('');

        // è½‰å¸³ç®—æ³•
        let debtors = balances.filter(b => b.balance < -0.01).sort((a, b) => a.balance - b.balance);
        let creditors = balances.filter(b => b.balance > 0.01).sort((a, b) => b.balance - a.balance);
        let transactions = [];

        let i = 0; 
        let j = 0;

        while (i < debtors.length && j < creditors.length) {
            let debtor = debtors[i];
            let creditor = creditors[j];
            let amount = Math.min(Math.abs(debtor.balance), creditor.balance);
            
            transactions.push({
                from: debtor.name,
                to: creditor.name,
                amount: amount
            });

            debtor.balance += amount;
            creditor.balance -= amount;

            if (Math.abs(debtor.balance) < 0.01) i++;
            if (creditor.balance < 0.01) j++;
        }

        const transferList = document.getElementById('transferList');
        if (transactions.length > 0) {
            transferList.innerHTML = transactions.map(t => `
                <div class="transfer-item">
                    <span>${t.from} <span style="font-size:12px; color:#999;">çµ¦</span> ${t.to}</span>
                    <span class="amount-highlight">$${t.amount.toFixed(0)}</span>
                </div>
            `).join('');
        } else {
            transferList.innerHTML = `<div style="text-align:center; padding:10px;">ğŸ‰ å¸³ç›®å·²å¹³ï¼Œç„¡éœ€è½‰å¸³</div>`;
        }
    }

    // ä¸‹è¼‰åœ–ç‰‡åŠŸèƒ½ (å·²ä¿®æ”¹ç‚ºåªæˆªå–çµæœå€å¡Š)
    function downloadImage() {
        // é–å®šç›®æ¨™å€å¡Š
        const element = document.getElementById("resultCaptureTarget"); 
        
        html2canvas(element, {
            scale: 2, // æé«˜è§£æåº¦
            backgroundColor: "#FFF9F0", // ç¢ºä¿èƒŒæ™¯è‰²æ­£ç¢º (ä½¿ç”¨å€å¡Šçš„æ¼¸å±¤è‰²åº•)
            useCORS: true
        }).then(canvas => {
            // å‰µå»ºä¸‹è¼‰é€£çµ
            let link = document.createElement('a');
            link.download = 'YONAçµç®—çµæœ.png';
            link.href = canvas.toDataURL("image/png");
            link.click();
        });
    }
</script>

</body>
</html>
