<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Yona's Splitter V5</title>
<link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@600&family=Quicksand:wght@500;700&family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">
<script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
<style>
    :root {
        --bg-color: #FDFCF8;
        --card-bg: #FFFFFF;
        --primary: #B09B88; /* å¥¶èŒ¶æ£• */
        --accent: #D4A373; /* æ©˜ */
        --text-main: #5A544F;
        --text-sub: #9C948B;
        --radius: 16px;
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

    body {
        font-family: 'Quicksand', 'Noto Sans TC', sans-serif;
        background-color: var(--bg-color);
        color: var(--text-main);
        margin: 0;
        padding: 20px;
        padding-bottom: 120px;
        max-width: 600px;
        margin: 0 auto;
    }

    h1 {
        font-family: 'Cormorant Garamond', serif;
        text-align: center;
        color: var(--primary);
        margin-bottom: 5px;
        font-size: 28px;
    }

    .card {
        background: var(--card-bg);
        border-radius: var(--radius);
        padding: 20px;
        margin-bottom: 15px;
        box-shadow: 0 4px 20px rgba(149, 133, 119, 0.08);
        border: 1px solid rgba(0,0,0,0.02);
    }

    /* è¨­å®šå€ */
    .setting-group { margin-bottom: 15px; }
    .setting-label { font-size: 13px; color: var(--text-sub); margin-bottom: 5px; display: block; }
    
    .payer-manager {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
    }
    .payer-tag {
        background: #F0F0F0;
        padding: 5px 10px;
        border-radius: 20px;
        font-size: 14px;
        display: flex;
        align-items: center;
        gap: 5px;
    }
    .btn-remove-payer {
        background: #CCC; color: white; border-radius: 50%; width: 16px; height: 16px;
        display: flex; align-items: center; justify-content: center; font-size: 10px; cursor: pointer; border: none;
    }
    .add-payer-row { display: flex; gap: 5px; margin-top: 10px; }

    /* è¼¸å…¥å€ */
    input {
        width: 100%; padding: 12px; border: 1px solid #EEE; border-radius: 10px;
        font-size: 15px; background: #FAFAFA; color: var(--text-main); outline: none;
        font-family: inherit;
    }
    
    /* ä»˜æ¬¾äººé¸æ“‡æŒ‰éˆ• */
    .payer-selector {
        display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 10px;
    }
    .payer-btn {
        padding: 8px 16px; border-radius: 10px; border: 1px solid #EEE; background: white;
        color: var(--text-sub); cursor: pointer; transition: 0.2s; font-size: 14px; flex: 1; text-align: center; white-space: nowrap;
    }
    .payer-btn.active {
        background: var(--primary); color: white; border-color: var(--primary); font-weight: bold; box-shadow: 0 2px 5px rgba(176,155,136,0.4);
    }

    .btn {
        width: 100%; padding: 12px; border: none; border-radius: 10px;
        background: #333; color: white; font-size: 16px; font-weight: bold; cursor: pointer; margin-top: 10px;
    }
    .btn.secondary { background: var(--accent); }

    /* æ¸…å–®åˆ—è¡¨ */
    .expense-list { list-style: none; padding: 0; margin: 0; }
    .expense-item {
        padding: 15px 0; border-bottom: 1px dashed #EEE;
        display: flex; justify-content: space-between; align-items: flex-start;
    }
    .item-left { flex: 1; padding-right: 10px; }
    .item-title { font-weight: bold; font-size: 15px; margin-bottom: 4px; line-height: 1.4; word-break: break-all; } /* æ”¯æ´é•·æª”åæ›è¡Œ */
    .item-meta { font-size: 12px; color: #BBB; display: flex; gap: 8px; align-items: center; }
    .payer-badge { background: var(--primary); color: white; padding: 2px 6px; border-radius: 4px; font-size: 10px; }
    
    .item-right { text-align: right; white-space: nowrap; display: flex; flex-direction: column; align-items: flex-end; }
    .item-price { font-weight: bold; font-size: 16px; color: var(--text-main); }
    .btn-del { color: #DDD; background: none; border: none; font-size: 18px; cursor: pointer; padding: 0; margin-top: 5px; }

    /* å ±å‘Šç”¢ç”Ÿå€ (éš±è—ï¼Œç”¨æ–¼æˆªåœ–) */
    #report-modal {
        position: fixed; top: 0; left: 0; right: 0; bottom: 0;
        background: rgba(0,0,0,0.5); z-index: 200;
        display: none; align-items: center; justify-content: center;
        padding: 20px;
    }
    #receipt-paper {
        background: #FFF; width: 100%; max-width: 400px;
        padding: 30px 20px;
        border-radius: 0; /* åƒæ”¶æ“šä¸€æ¨£ */
        box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        max-height: 85vh; overflow-y: auto;
        font-family: 'Courier Prime', 'Noto Sans TC', monospace; /* æ”¶æ“šå­—é«” */
        position: relative;
    }
    /* é‹¸é½’é‚Šç·£è£é£¾ */
    #receipt-paper::before {
        content: ""; position: absolute; top: -5px; left: 0; right: 0; height: 10px;
        background: radial-gradient(circle, transparent 5px, #fff 5px) repeat-x; background-size: 10px 10px;
    }
    
    .receipt-header { text-align: center; border-bottom: 2px dashed #333; padding-bottom: 15px; margin-bottom: 15px; }
    .receipt-title { font-size: 20px; font-weight: bold; margin-bottom: 5px; }
    .receipt-row { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 13px; line-height: 1.4; }
    .receipt-divider { border-bottom: 1px dashed #CCC; margin: 15px 0; }
    .receipt-total { font-size: 18px; font-weight: bold; text-align: right; margin-top: 10px; }
    
    .settlement-box { background: #F8F8F8; padding: 10px; border-radius: 8px; margin-top: 15px; }
    .settlement-row { display: flex; justify-content: space-between; font-weight: bold; margin-bottom: 5px; font-size: 13px; }

</style>
</head>
<body>

    <h1>Travel Splitter</h1>
    
    <div class="card">
        <div class="setting-group">
            <label class="setting-label">ğŸ—ºï¸ æ—…ç¨‹ç¸½äººæ•¸ (åˆ†æ¯)</label>
            <div style="display:flex; align-items:center; gap:5px;">
                <input type="number" id="totalTravelers" value="4" style="width:80px; text-align:center;">
                <span style="font-size:14px;">äºº</span>
            </div>
        </div>

        <div class="setting-group">
            <label class="setting-label">ğŸ’³ ç®¡ç†ä»˜æ¬¾äºº (èª°æœƒå…ˆå¢ŠéŒ¢)</label>
            <div class="payer-manager" id="payerTags">
                </div>
            <div class="add-payer-row">
                <input type="text" id="newPayerName" placeholder="è¼¸å…¥åå­—..." style="font-size:13px;">
                <button class="btn secondary" onclick="addPayer()" style="width:auto; margin:0;">æ–°å¢</button>
            </div>
        </div>
    </div>

    <div class="card">
        <label class="setting-label">èª°å…ˆä»˜çš„ï¼Ÿ</label>
        <div class="payer-selector" id="payerButtons">
            </div>

        <div style="display:flex; gap:10px; margin-bottom:10px;">
            <input type="date" id="dateInput">
            <input type="time" id="timeInput">
        </div>
        
        <input type="text" id="itemName" placeholder="æ¶ˆè²»é …ç›® (å¦‚: 7-11 é£²æ–™é›¶é£Ÿ)" style="margin-bottom:10px;">
        <input type="number" id="priceInput" placeholder="é‡‘é¡ $" inputmode="numeric">
        
        <button class="btn" onclick="addExpense()">ï¼‹ è¨˜ä¸€ç­†</button>
    </div>

    <div class="card">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
            <h3 style="margin:0; font-size:14px; color:var(--text-sub);">æ¶ˆè²»æ˜ç´°</h3>
            <button onclick="showReport()" style="background:none; border:1px solid var(--primary); color:var(--primary); padding:5px 10px; border-radius:15px; cursor:pointer; font-size:12px;">ğŸ§¾ ç”¢å‡ºçµç®—æ˜ç´°è¡¨</button>
        </div>
        <ul class="expense-list" id="list">
            <li style="text-align:center; padding:20px; color:#ddd;">æš«ç„¡è³‡æ–™</li>
        </ul>
    </div>

    <div id="report-modal">
        <div id="receipt-paper">
            <div class="receipt-header">
                <div class="receipt-title">Trip Expenses</div>
                <div style="font-size:12px; color:#888;" id="reportDate"></div>
            </div>

            <div id="report-list"></div>

            <div class="receipt-divider"></div>

            <div class="receipt-row">
                <span>Total Cost</span>
                <span id="report-total" style="font-weight:bold;">$0</span>
            </div>
            <div class="receipt-row">
                <span>Avg / Person</span>
                <span id="report-avg">$0</span>
            </div>

            <div class="settlement-box">
                <div style="text-align:center; font-size:12px; margin-bottom:8px; border-bottom:1px solid #ddd; padding-bottom:5px;">SETTLEMENT (çµç®—)</div>
                <div id="report-settlement"></div>
            </div>

            <div style="margin-top:20px; text-align:center;">
                <button class="btn" onclick="downloadReport()">â¬‡ï¸ ä¸‹è¼‰åœ–ç‰‡</button>
                <button class="btn" onclick="closeReport()" style="background:#ddd; color:#555; margin-top:5px;">é—œé–‰</button>
            </div>
        </div>
    </div>

<script>
    // è³‡æ–™ç‹€æ…‹
    let payers = ['Cindy', 'è€å…¬']; // é è¨­åå–®
    let expenses = [];
    let currentPayer = '';

    // åˆå§‹åŒ–
    const dateInput = document.getElementById('dateInput');
    const timeInput = document.getElementById('timeInput');
    const now = new Date();
    dateInput.value = now.toISOString().split('T')[0];
    timeInput.value = now.toTimeString().slice(0, 5);

    renderPayerUI();

    // --- ä»˜æ¬¾äººç®¡ç†é‚è¼¯ ---
    function renderPayerUI() {
        const tagContainer = document.getElementById('payerTags');
        const btnContainer = document.getElementById('payerButtons');
        
        tagContainer.innerHTML = '';
        btnContainer.innerHTML = '';

        payers.forEach((name, index) => {
            // 1. è¨­å®šå€çš„æ¨™ç±¤ (å¯åˆªé™¤)
            const tag = document.createElement('div');
            tag.className = 'payer-tag';
            tag.innerHTML = `${name} <button class="btn-remove-payer" onclick="removePayer(${index})">Ã—</button>`;
            tagContainer.appendChild(tag);

            // 2. è¨˜å¸³å€çš„æŒ‰éˆ•
            const btn = document.createElement('div');
            btn.className = `payer-btn ${currentPayer === name ? 'active' : ''}`;
            btn.textContent = name;
            btn.onclick = () => {
                currentPayer = name;
                renderPayerUI(); // é‡æ–°æ¸²æŸ“ä»¥æ›´æ–° active ç‹€æ…‹
            };
            btnContainer.appendChild(btn);
        });

        // å¦‚æœç•¶å‰é¸çš„äººè¢«åˆªæ‰äº†ï¼Œé‡ç½®
        if (!payers.includes(currentPayer) && payers.length > 0) {
            currentPayer = payers[0];
            // éè¿´åˆ·æ–°ä¸€æ¬¡ç¢ºä¿é¸ä¸­ç¬¬ä¸€å€‹
            // ä½†ç‚ºäº†é¿å…ç„¡é™è¿´åœˆï¼Œç›´æ¥æ“ä½œ DOM class å³å¯ï¼Œæˆ–å†æ¬¡å‘¼å«
            setTimeout(renderPayerUI, 0); 
        }
    }

    function addPayer() {
        const input = document.getElementById('newPayerName');
        const name = input.value.trim();
        if (name && !payers.includes(name)) {
            payers.push(name);
            input.value = '';
            renderPayerUI();
        } else if (payers.includes(name)) {
            alert('é€™å€‹åå­—å·²ç¶“æœ‰äº†å–”ï¼');
        }
    }

    function removePayer(index) {
        if (confirm(`ç¢ºå®šè¦ç§»é™¤ã€Œ${payers[index]}ã€å—ï¼Ÿ(ä¸æœƒåˆªé™¤ä»–å·²ç¶“è¨˜éçš„å¸³)`)) {
            payers.splice(index, 1);
            renderPayerUI();
        }
    }

    // --- è¨˜å¸³é‚è¼¯ ---
    function addExpense() {
        const name = document.getElementById('itemName').value.trim();
        const price = parseInt(document.getElementById('priceInput').value);
        
        if (!currentPayer) { alert('è«‹å…ˆæ–°å¢ä¸¦é¸æ“‡ä¸€ä½ä»˜æ¬¾äººï¼'); return; }
        if (!name || isNaN(price)) { alert('è«‹è¼¸å…¥é …ç›®å’Œé‡‘é¡'); return; }

        expenses.push({
            id: Date.now(),
            date: dateInput.value,
            time: timeInput.value,
            item: name,
            price: price,
            payer: currentPayer
        });

        document.getElementById('itemName').value = '';
        document.getElementById('priceInput').value = '';
        renderList();
    }

    function deleteExpense(id) {
        if(confirm('åˆªé™¤é€™ç­†ï¼Ÿ')) {
            expenses = expenses.filter(e => e.id !== id);
            renderList();
        }
    }

    function renderList() {
        const list = document.getElementById('list');
        list.innerHTML = '';
        
        expenses.sort((a, b) => b.id - a.id).forEach(e => {
            const li = document.createElement('li');
            li.className = 'expense-item';
            
            // æ—¥æœŸæ ¼å¼åŒ– mm/dd
            const d = new Date(e.date);
            const dateStr = `${d.getMonth()+1}/${d.getDate()}`;

            li.innerHTML = `
                <div class="item-left">
                    <div class="item-title">${e.item}</div>
                    <div class="item-meta">
                        <span class="payer-badge">${e.payer}</span>
                        <span>${dateStr} ${e.time}</span>
                    </div>
                </div>
                <div class="item-right">
                    <div class="item-price">$${e.price.toLocaleString()}</div>
                    <button class="btn-del" onclick="deleteExpense(${e.id})">ğŸ—‘ï¸</button>
                </div>
            `;
            list.appendChild(li);
        });
        
        if(expenses.length === 0) list.innerHTML = '<li style="text-align:center; padding:20px; color:#ddd;">æš«ç„¡è³‡æ–™</li>';
    }

    // --- å ±è¡¨èˆ‡çµç®—é‚è¼¯ ---
    function showReport() {
        const modal = document.getElementById('report-modal');
        const reportList = document.getElementById('report-list');
        const reportSettlement = document.getElementById('report-settlement');
        
        // 1. å¡«å¯«è¡¨é ­æ—¥æœŸ
        document.getElementById('reportDate').textContent = new Date().toLocaleString();

        // 2. å¡«å¯«æ˜ç´° (ä¾ç…§æ™‚é–“é †åºï¼šèˆŠ -> æ–°)
        reportList.innerHTML = '';
        let totalCost = 0;
        let paidMap = {}; // ç´€éŒ„æ¯å€‹äººä»˜äº†å¤šå°‘ { Cindy: 5000, è€å…¬: 2000 }

        // å…ˆåˆå§‹åŒ– paidMap
        payers.forEach(p => paidMap[p] = 0); 
        
        // é‡æ–°æ’åºç‚ºèˆŠåˆ°æ–° (å ±è¡¨ç¿’æ…£)
        const sortedExpenses = [...expenses].sort((a, b) => a.id - b.id);

        sortedExpenses.forEach(e => {
            totalCost += e.price;
            if (!paidMap[e.payer]) paidMap[e.payer] = 0;
            paidMap[e.payer] += e.price;

            const row = document.createElement('div');
            row.className = 'receipt-row';
            row.innerHTML = `
                <div style="flex:2;">${e.item} <span style="font-size:10px; color:#999;">(${e.payer})</span></div>
                <div style="flex:1; text-align:right;">$${e.price.toLocaleString()}</div>
            `;
            reportList.appendChild(row);
        });

        // 3. å¡«å¯«ç¸½è¨ˆ
        const totalTravelers = parseInt(document.getElementById('totalTravelers').value) || 1;
        const avg = Math.ceil(totalCost / totalTravelers);

        document.getElementById('report-total').textContent = `$${totalCost.toLocaleString()}`;
        document.getElementById('report-avg').textContent = `$${avg.toLocaleString()}`;

        // 4. è¨ˆç®—çµç®— (Settlement)
        // åƒèˆ‡è€… = ä»˜æ¬¾éçš„äºº + (å¦‚æœç¸½äººæ•¸ > ä»˜æ¬¾äººæ•¸ï¼Œä»£è¡¨æœ‰éš±å½¢äºº)
        // ç‚ºäº†ç°¡åŒ–ï¼Œæˆ‘å€‘è¨ˆç®— "æœ‰ä»˜æ¬¾ç´€éŒ„çš„äºº" å’Œ "å…¶é¤˜æ—…ä¼´"
        
        let balances = [];
        
        // åŠ å…¥æ‰€æœ‰åœ¨ "ä»˜æ¬¾äººåå–®" ä¸Šçš„äºº (å³ä½¿ä»–æ²’ä»˜éŒ¢ï¼Œåªè¦ä»–åœ¨åå–®ä¸Šå°±ç®—ä¸€ä»½å­)
        payers.forEach(name => {
            const paid = paidMap[name] || 0;
            balances.push({ name: name, balance: paid - avg });
        });

        // æª¢æŸ¥æ˜¯å¦æœ‰ "æ²’åœ¨åå–®ä¸Šçš„å…¶é¤˜æ—…ä¼´"
        // å‡è¨­ç¸½äººæ•¸ 6ï¼Œåå–®åªæœ‰ A, Bã€‚é‚£é‚„æœ‰ 4 å€‹éš±å½¢äººï¼Œä»–å€‘ä»˜äº† 0ï¼Œæ¬  avg
        const ghostCount = totalTravelers - payers.length;
        if (ghostCount > 0) {
            balances.push({
                name: `å…¶é¤˜æ—…ä¼´(${ghostCount}äºº)`,
                balance: -(avg * ghostCount)
            });
        }

        // é–‹å§‹é…å°
        let debtors = balances.filter(p => p.balance < 0).sort((a,b) => a.balance - b.balance);
        let creditors = balances.filter(p => p.balance > 0).sort((a,b) => b.balance - a.balance);

        let html = '';
        let i = 0, j = 0;

        while (i < debtors.length && j < creditors.length) {
            let debtor = debtors[i];
            let creditor = creditors[j];
            let debt = Math.abs(debtor.balance);
            let credit = creditor.balance;
            let amount = Math.min(debt, credit);

            if (amount > 0) {
                html += `
                    <div class="settlement-row">
                        <span>${debtor.name} â” ${creditor.name}</span>
                        <span>$${Math.ceil(amount).toLocaleString()}</span>
                    </div>
                `;
            }

            debtor.balance += amount;
            creditor.balance -= amount;

            if (Math.abs(debtor.balance) < 1) i++;
            if (creditor.balance < 1) j++;
        }

        reportSettlement.innerHTML = html || '<div style="text-align:center;">å¸³å‹™å¹³è¡¡</div>';
        
        modal.style.display = 'flex';
    }

    function closeReport() {
        document.getElementById('report-modal').style.display = 'none';
    }

    function downloadReport() {
        const paper = document.getElementById('receipt-paper');
        html2canvas(paper, { scale: 2 }).then(canvas => {
            const link = document.createElement('a');
            link.download = 'travel-expense-report.png';
            link.href = canvas.toDataURL();
            link.click();
        });
    }

</script>

</body>
</html>
