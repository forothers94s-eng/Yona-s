<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Yona's Splitter V9</title>
<link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@600&family=Quicksand:wght@500;700&family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">
<script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
<style>
    :root {
        --bg-color: #FDFCF8;
        --card-bg: #FFFFFF;
        --primary: #B09B88; /* å¥¶èŒ¶æ£• */
        --accent: #D4A373; /* æ©˜ */
        --repay: #6B8E23;   /* é‚„æ¬¾ç¶  */
        --text-main: #5A544F;
        --text-sub: #9C948B;
        --radius: 16px;
        --select-blue: #8DA399; 
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

    body {
        font-family: 'Quicksand', 'Noto Sans TC', sans-serif;
        background-color: var(--bg-color);
        color: var(--text-main);
        margin: 0; padding: 20px; padding-bottom: 120px;
        max-width: 600px; margin: 0 auto;
    }

    h1 {
        font-family: 'Cormorant Garamond', serif; text-align: center;
        color: var(--primary); margin-bottom: 5px; font-size: 28px;
    }

    .card {
        background: var(--card-bg); border-radius: var(--radius); padding: 20px;
        margin-bottom: 15px; box-shadow: 0 4px 20px rgba(149, 133, 119, 0.08);
        border: 1px solid rgba(0,0,0,0.02);
    }

    .setting-label { font-size: 13px; color: var(--text-sub); margin-bottom: 8px; display: block; font-weight: bold; }
    
    /* æˆå“¡è¨­å®š */
    .member-list { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 10px; }
    .member-tag {
        background: #F0F0F0; padding: 6px 12px; border-radius: 20px;
        font-size: 14px; display: flex; align-items: center; gap: 6px; color: #555;
    }
    .btn-remove {
        background: #CCC; color: white; border-radius: 50%; width: 18px; height: 18px;
        display: flex; align-items: center; justify-content: center; font-size: 10px; cursor: pointer; border: none;
    }
    .add-row { display: flex; gap: 8px; }

    input, select {
        width: 100%; padding: 12px; border: 1px solid #EEE; border-radius: 10px;
        font-size: 15px; background: #FAFAFA; color: var(--text-main); outline: none;
        font-family: inherit;
    }

    /* æ¨¡å¼åˆ‡æ› Tabs */
    .mode-tabs { display: flex; background: #EEE; border-radius: 12px; padding: 4px; margin-bottom: 15px; }
    .tab-btn {
        flex: 1; text-align: center; padding: 10px; border-radius: 10px; cursor: pointer; font-weight: bold; font-size: 14px; transition: 0.3s;
        color: #999;
    }
    .tab-btn.active.expense { background: white; color: var(--primary); box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
    .tab-btn.active.repay { background: white; color: var(--repay); box-shadow: 0 2px 5px rgba(0,0,0,0.05); }

    /* æŒ‰éˆ•å€å¡Š */
    .selector-grid { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 15px; }
    
    /* ä»˜æ¬¾äººæŒ‰éˆ• */
    .payer-btn {
        flex: 1; min-width: 60px; padding: 8px; border-radius: 10px; border: 1px solid #EEE; 
        background: white; color: #999; cursor: pointer; text-align: center; font-size: 13px;
        transition: 0.2s;
    }
    .payer-btn.active { background: var(--primary); color: white; border-color: var(--primary); font-weight: bold; }

    /* Check List æŒ‰éˆ• */
    .splitter-btn {
        flex: 1; min-width: 60px; padding: 8px; border-radius: 10px; border: 1px solid #EEE; 
        background: white; color: #DDD; cursor: pointer; text-align: center; font-size: 13px;
        transition: 0.2s;
        display: flex; align-items: center; justify-content: center; gap: 5px;
    }
    .splitter-btn::before { content: 'â—‹'; font-size: 10px; }
    .splitter-btn.active {
        background: var(--select-blue); color: white; border-color: var(--select-blue); font-weight: bold;
    }
    .splitter-btn.active::before { content: 'âœ”'; }

    .btn {
        width: 100%; padding: 12px; border: none; border-radius: 10px;
        background: #333; color: white; font-size: 16px; font-weight: bold; cursor: pointer; margin-top: 10px;
    }
    .btn.secondary { background: var(--accent); }
    .btn.repay-submit { background: var(--repay); }

    /* æ¸…å–® */
    .expense-list { list-style: none; padding: 0; margin: 0; }
    .expense-item {
        padding: 15px 0; border-bottom: 1px dashed #EEE;
        display: flex; justify-content: space-between; align-items: center;
    }
    
    .tag-type { font-size: 10px; padding: 2px 6px; border-radius: 4px; margin-right: 5px; color: white; vertical-align: middle; }
    .tag-exp { background: var(--primary); }
    .tag-repay { background: var(--repay); }

    .item-info { flex: 1; }
    .item-title { font-weight: bold; font-size: 15px; margin-bottom: 4px; }
    .item-sub { font-size: 12px; color: #BBB; line-height: 1.4; }

    .item-right { text-align: right; }
    .item-price { font-weight: bold; font-size: 16px; color: var(--text-main); }
    .item-price.is-repay { color: var(--repay); }
    
    .btn-del { color: #DDD; background: none; border: none; font-size: 18px; cursor: pointer; padding: 5px; }

    /* å ±è¡¨ */
    #report-modal {
        position: fixed; top: 0; left: 0; right: 0; bottom: 0;
        background: rgba(0,0,0,0.5); z-index: 200;
        display: none; align-items: center; justify-content: center; padding: 20px;
    }
    #receipt-paper {
        background: #FFF; width: 100%; max-width: 400px;
        padding: 30px 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        max-height: 85vh; overflow-y: auto;
        font-family: 'Courier Prime', 'Noto Sans TC', monospace;
    }
    .receipt-row { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 13px; line-height: 1.4; }
    .receipt-divider { border-bottom: 1px dashed #CCC; margin: 15px 0; }
    .settlement-block { background: #F9F9F9; padding: 15px; border-radius: 8px; margin-top: 15px; }
    .settlement-row {
        display: flex; justify-content: space-between; align-items: center;
        margin-bottom: 8px; font-size: 13px; border-bottom: 1px dotted #E0E0E0; padding-bottom: 4px;
    }

</style>
</head>
<body>

    <h1>Splitter V9</h1>
    
    <div class="card">
        <label class="setting-label">ğŸ‘¥ åƒèˆ‡äººå“¡ (è«‹å…ˆè¨­å®š)</label>
        <div class="member-list" id="memberTags"></div>
        <div class="add-row">
            <input type="text" id="newMemberName" placeholder="è¼¸å…¥åå­— (å¦‚: èŠç‘, å°ç¾)" style="font-size:14px;">
            <button class="btn secondary" onclick="addMember()" style="width:auto; margin:0;">æ–°å¢</button>
        </div>
    </div>

    <div class="card">
        <div class="mode-tabs">
            <div id="tabExpense" class="tab-btn active expense" onclick="switchMode('expense')">æ–°å¢èŠ±è²» (Expense)</div>
            <div id="tabRepay" class="tab-btn" onclick="switchMode('repay')">ç´€éŒ„é‚„æ¬¾ (Mark as Paid)</div>
        </div>

        <div style="display:flex; gap:10px; margin-bottom:10px;">
            <input type="date" id="dateInput">
        </div>

        <div id="formExpense">
            <input type="text" id="expenseTitle" placeholder="Title: æ¶ˆè²»é …ç›® (å¦‚: æµ·ç”¢åº—)" style="margin-bottom:10px;">
            <input type="number" id="expenseAmount" placeholder="Amount: é‡‘é¡ $" inputmode="decimal" style="margin-bottom:15px;">
            
            <label class="setting-label" style="color:var(--primary);">Paid By (èª°å…ˆä»˜éŒ¢?)</label>
            <div class="selector-grid" id="payerButtons">
                <div style="font-size:12px; color:#bbb;">è«‹å…ˆæ–°å¢æˆå“¡...</div>
            </div>

            <label class="setting-label" style="color:var(--select-blue);">Check List (èª°æœ‰åƒ? é»æ“Šæ’é™¤/åŠ å…¥)</label>
            <div class="selector-grid" id="splitterButtons">
                <div style="font-size:12px; color:#bbb;">è«‹å…ˆæ–°å¢æˆå“¡...</div>
            </div>

            <button class="btn" onclick="addTransaction('expense')">ï¼‹ æ–°å¢èŠ±è²»</button>
        </div>

        <div id="formRepay" style="display:none;">
            <div style="display:flex; align-items:center; gap:10px; margin-bottom:15px;">
                <select id="repayFrom">
                    <option value="" disabled selected>èª°é‚„éŒ¢?</option>
                </select>
                <span>â” çµ¦ â”</span>
                <select id="repayTo">
                    <option value="" disabled selected>èª°æ”¶éŒ¢?</option>
                </select>
            </div>
            
            <input type="number" id="repayAmount" placeholder="Amount: é‚„äº†å¤šå°‘éŒ¢ $" inputmode="decimal">
            <div style="font-size:12px; color:#999; margin-top:8px;">* ç´€éŒ„æ­¤ç­†å¾Œï¼Œå ±è¡¨çš„æ¬ æ¬¾é‡‘é¡æœƒè‡ªå‹•æ‰£é™¤</div>
            
            <button class="btn repay-submit" onclick="addTransaction('repay')">âœ” ç´€éŒ„é‚„æ¬¾ (Mark as Paid)</button>
        </div>
    </div>

    <div class="card">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
            <h3 style="margin:0; font-size:14px; color:var(--text-sub);">Transaction History</h3>
            <button onclick="showReport()" style="background:none; border:1px solid var(--primary); color:var(--primary); padding:6px 12px; border-radius:20px; cursor:pointer; font-size:12px; font-weight:bold;">ğŸ“Š çµç®—å ±è¡¨</button>
        </div>
        <ul class="expense-list" id="list">
            <li style="text-align:center; padding:20px; color:#ddd;">æš«ç„¡ç´€éŒ„</li>
        </ul>
    </div>

    <div id="report-modal">
        <div id="receipt-paper">
            <div style="text-align:center; border-bottom:2px dashed #333; padding-bottom:15px; margin-bottom:15px;">
                <div style="font-size:20px; font-weight:bold;">Settlement Report</div>
                <div style="font-size:12px; color:#888;" id="reportDate"></div>
            </div>

            <div class="receipt-row">
                <span>Total Expenses</span>
                <span id="report-total" style="font-weight:bold;">$0.00</span>
            </div>
            <div class="receipt-divider"></div>

            <div class="settlement-block">
                <div style="text-align:center; font-size:12px; margin-bottom:10px; font-weight:bold; color:#555;">WHO OWES WHOM (çµç®—å»ºè­°)</div>
                <div id="report-settlement"></div>
            </div>

            <div style="margin-top:15px; font-size:11px; color:#aaa;">
                <div>Net Balances (æ·¨é¡ç‹€æ…‹):</div>
                <div id="report-balances"></div>
            </div>

            <div style="margin-top:20px; text-align:center;">
                <button class="btn" onclick="downloadReport()">â¬‡ï¸ ä¸‹è¼‰åœ–ç‰‡</button>
                <button class="btn" onclick="closeReport()" style="background:#ddd; color:#555; margin-top:5px;">é—œé–‰</button>
            </div>
        </div>
    </div>

<script>
    let members = [];
    let historyList = []; // å­˜æ‰€æœ‰çš„äº¤æ˜“ (åŒ…å«èŠ±è²»èˆ‡é‚„æ¬¾)
    
    // UI ç‹€æ…‹
    let currentPayer = ''; 
    let currentSplitters = []; 
    let currentMode = 'expense';

    // åˆå§‹åŒ–
    const dateInput = document.getElementById('dateInput');
    dateInput.value = new Date().toISOString().split('T')[0];

    // --- æˆå“¡ç®¡ç† ---
    function addMember() {
        const input = document.getElementById('newMemberName');
        const name = input.value.trim();
        if (name && !members.includes(name)) {
            members.push(name);
            input.value = '';
            currentSplitters.push(name); // é è¨­åŠ å…¥ CheckList
            renderUI();
            updateRepaySelects();
        } else if (members.includes(name)) { alert('åå­—é‡è¤‡å›‰ï¼'); }
    }

    function removeMember(index) {
        if (confirm(`ç§»é™¤ã€Œ${members[index]}ã€ï¼Ÿ`)) {
            const name = members[index];
            members.splice(index, 1);
            currentSplitters = currentSplitters.filter(n => n !== name);
            if(currentPayer === name) currentPayer = '';
            renderUI();
            updateRepaySelects();
        }
    }

    // --- UI æ¸²æŸ“ ---
    function renderUI() {
        // 1. æˆå“¡æ¨™ç±¤
        const tagBox = document.getElementById('memberTags');
        tagBox.innerHTML = '';
        members.forEach((name, idx) => {
            const tag = document.createElement('div');
            tag.className = 'member-tag';
            tag.innerHTML = `${name} <button class="btn-remove" onclick="removeMember(${idx})">Ã—</button>`;
            tagBox.appendChild(tag);
        });

        // 2. Paid By (å–®é¸)
        const payerBox = document.getElementById('payerButtons');
        payerBox.innerHTML = '';
        if (members.length === 0) payerBox.innerHTML = '<div style="font-size:12px; color:#bbb;">è«‹å…ˆæ–°å¢æˆå“¡...</div>';
        if (!currentPayer && members.length > 0) currentPayer = members[0];

        members.forEach(name => {
            const btn = document.createElement('div');
            btn.className = `payer-btn ${currentPayer === name ? 'active' : ''}`;
            btn.textContent = name;
            btn.onclick = () => { currentPayer = name; renderUI(); };
            payerBox.appendChild(btn);
        });

        // 3. Check List (å¤šé¸)
        const splitterBox = document.getElementById('splitterButtons');
        splitterBox.innerHTML = '';
        if (members.length === 0) splitterBox.innerHTML = '<div style="font-size:12px; color:#bbb;">è«‹å…ˆæ–°å¢æˆå“¡...</div>';
        
        members.forEach(name => {
            const isActive = currentSplitters.includes(name);
            const btn = document.createElement('div');
            btn.className = `splitter-btn ${isActive ? 'active' : ''}`;
            btn.textContent = name;
            btn.onclick = () => { toggleSplitter(name); };
            splitterBox.appendChild(btn);
        });
    }

    function updateRepaySelects() {
        const fromSel = document.getElementById('repayFrom');
        const toSel = document.getElementById('repayTo');
        fromSel.innerHTML = '<option value="" disabled selected>èª°é‚„éŒ¢?</option>';
        toSel.innerHTML = '<option value="" disabled selected>èª°æ”¶éŒ¢?</option>';
        
        members.forEach(m => {
            fromSel.add(new Option(m, m));
            toSel.add(new Option(m, m));
        });
    }

    function toggleSplitter(name) {
        if (currentSplitters.includes(name)) {
            currentSplitters = currentSplitters.filter(n => n !== name);
        } else {
            currentSplitters.push(name);
        }
        renderUI();
    }

    function switchMode(mode) {
        currentMode = mode;
        const tabExp = document.getElementById('tabExpense');
        const tabRep = document.getElementById('tabRepay');
        const formExp = document.getElementById('formExpense');
        const formRep = document.getElementById('formRepay');

        if (mode === 'expense') {
            tabExp.classList.add('active'); tabRep.classList.remove('active');
            formExp.style.display = 'block'; formRep.style.display = 'none';
        } else {
            tabExp.classList.remove('active'); tabRep.classList.add('active');
            formExp.style.display = 'none'; formRep.style.display = 'block';
        }
    }

    // --- æ ¸å¿ƒï¼šæ–°å¢äº¤æ˜“ ---
    function addTransaction(type) {
        const date = dateInput.value;
        const id = Date.now();

        if (type === 'expense') {
            const title = document.getElementById('expenseTitle').value.trim();
            const amount = parseFloat(document.getElementById('expenseAmount').value);
            
            if (members.length === 0) { alert('è«‹å…ˆæ–°å¢æˆå“¡'); return; }
            if (!title || isNaN(amount)) { alert('è«‹è¼¸å…¥é …ç›®å’Œé‡‘é¡'); return; }
            if (currentSplitters.length === 0) { alert('Check List è‡³å°‘è¦é¸ä¸€å€‹äººï¼'); return; }

            historyList.push({
                id, type: 'expense', date,
                title, amount,
                payer: currentPayer,
                involved: [...currentSplitters]
            });

            // æ¸…ç©ºè¼¸å…¥
            document.getElementById('expenseTitle').value = '';
            document.getElementById('expenseAmount').value = '';

        } else if (type === 'repay') {
            const from = document.getElementById('repayFrom').value;
            const to = document.getElementById('repayTo').value;
            const amount = parseFloat(document.getElementById('repayAmount').value);

            if (!from || !to || isNaN(amount)) { alert('è«‹å¡«å¯«å®Œæ•´é‚„æ¬¾è³‡è¨Š'); return; }
            if (from === to) { alert('ä¸èƒ½è‡ªå·±é‚„éŒ¢çµ¦è‡ªå·±å–” XD'); return; }

            historyList.push({
                id, type: 'repay', date,
                from, to, amount
            });

            document.getElementById('repayAmount').value = '';
        }

        renderList();
    }

    function deleteItem(id) {
        if(confirm('ç¢ºå®šåˆªé™¤æ­¤ç­†ç´€éŒ„ï¼Ÿ')) {
            historyList = historyList.filter(e => e.id !== id);
            renderList();
        }
    }

    function renderList() {
        const list = document.getElementById('list');
        list.innerHTML = '';
        
        // æ’åºï¼šæ–° -> èˆŠ
        historyList.sort((a, b) => b.id - a.id).forEach(e => {
            const li = document.createElement('li');
            li.className = 'expense-item';
            
            let leftContent = '';
            let rightContent = '';
            const d = new Date(e.date);
            const dateStr = `${d.getMonth()+1}/${d.getDate()}`;

            if (e.type === 'expense') {
                const splitDesc = e.involved.length === members.length ? "å…¨å“¡" : `(${e.involved.length}äºº)`;
                leftContent = `
                    <div class="item-title"><span class="tag-type tag-exp">æ¶ˆè²»</span>${e.title}</div>
                    <div class="item-sub">${dateStr} Â· ${e.payer} ä»˜æ¬¾ Â· åˆ†æ”¤: ${e.involved.join(', ')}</div>
                `;
                rightContent = `<div class="item-price">$${e.amount.toLocaleString()}</div>`;
            } else {
                leftContent = `
                    <div class="item-title"><span class="tag-type tag-repay">é‚„æ¬¾</span>${e.from} â” ${e.to}</div>
                    <div class="item-sub">${dateStr} Â· Mark as paid</div>
                `;
                rightContent = `<div class="item-price is-repay">$${e.amount.toLocaleString()}</div>`;
            }

            li.innerHTML = `
                <div class="item-info">${leftContent}</div>
                <div class="item-right">
                    ${rightContent}
                    <button class="btn-del" onclick="deleteItem(${e.id})">ğŸ—‘ï¸</button>
                </div>
            `;
            list.appendChild(li);
        });

        if(historyList.length === 0) list.innerHTML = '<li style="text-align:center; padding:20px; color:#ddd;">æš«ç„¡ç´€éŒ„</li>';
    }

    // --- çµç®—å¼•æ“ (åŒ…å«å°æ•¸é»èˆ‡é‚„æ¬¾é‚è¼¯) ---
    function showReport() {
        const modal = document.getElementById('report-modal');
        const reportDate = document.getElementById('reportDate');
        const reportTotal = document.getElementById('report-total');
        const reportSettlement = document.getElementById('report-settlement');
        const reportBalances = document.getElementById('report-balances');
        
        reportDate.textContent = new Date().toLocaleString();

        let balances = {};
        members.forEach(m => balances[m] = 0);
        let totalExp = 0;

        // 1. è¨ˆç®—æ‰€æœ‰é¤˜é¡
        historyList.forEach(e => {
            if (e.type === 'expense') {
                totalExp += e.amount;
                // Payer å…ˆå‡ºéŒ¢ (Credit +)
                if (balances[e.payer] === undefined) balances[e.payer] = 0;
                balances[e.payer] += e.amount;

                // Splitters æ¬ éŒ¢ (Debt -)
                const count = e.involved.length;
                if (count > 0) {
                    const share = e.amount / count;
                    e.involved.forEach(p => {
                        if (balances[p] === undefined) balances[p] = 0;
                        balances[p] -= share;
                    });
                }
            } else if (e.type === 'repay') {
                // From é‚„äº†éŒ¢ -> å‚µå‹™æ¸›å°‘ (Credit +)
                // To æ”¶äº†éŒ¢ -> å‚µæ¬Šæ¸›å°‘ (Credit -)
                if (balances[e.from] === undefined) balances[e.from] = 0;
                if (balances[e.to] === undefined) balances[e.to] = 0;
                
                balances[e.from] += e.amount;
                balances[e.to] -= e.amount;
            }
        });

        reportTotal.textContent = `$${totalExp.toFixed(2)}`;

        // 2. é¡¯ç¤ºæ¯å€‹äººçš„æ·¨é¡ (Debugç”¨ï¼Œä¹Ÿæ–¹ä¾¿çœ‹)
        let balanceHtml = '';
        for (const [m, val] of Object.entries(balances)) {
            const color = val >= 0 ? 'green' : 'red';
            balanceHtml += `<span style="color:${color}; margin-right:8px;">${m}: $${val.toFixed(2)}</span> `;
        }
        reportBalances.innerHTML = balanceHtml;

        // 3. é…å°çµç®—
        let debtors = [];
        let creditors = [];

        // éæ¿¾æ‰é‡‘é¡å¾ˆå° (å°æ–¼ 0.01) çš„èª¤å·®
        for (const [name, val] of Object.entries(balances)) {
            if (val < -0.01) debtors.push({ name, amount: Math.abs(val) });
            if (val > 0.01) creditors.push({ name, amount: val });
        }

        debtors.sort((a,b) => b.amount - a.amount);
        creditors.sort((a,b) => b.amount - a.amount);

        let html = '';
        let i = 0, j = 0;

        while (i < debtors.length && j < creditors.length) {
            let debtor = debtors[i];
            let creditor = creditors[j];
            
            // å–æœ€å°å€¼
            let amount = Math.min(debtor.amount, creditor.amount);

            html += `
                <div class="settlement-row">
                    <span>${debtor.name} <span style="color:#aaa; font-size:10px;">â”çµ¦â”</span> ${creditor.name}</span>
                    <span style="font-weight:bold;">$${amount.toFixed(2)}</span>
                </div>
            `;

            debtor.amount -= amount;
            creditor.amount -= amount;

            if (debtor.amount < 0.01) i++;
            if (creditor.amount < 0.01) j++;
        }

        reportSettlement.innerHTML = html || '<div style="text-align:center; color:#999;">âœ¨ å¸³å‹™å·²çµæ¸… (No debts)</div>';
        modal.style.display = 'flex';
    }

    function closeReport() { document.getElementById('report-modal').style.display = 'none'; }
    function downloadReport() {
        html2canvas(document.getElementById('receipt-paper'), { scale: 2 }).then(canvas => {
            const link = document.createElement('a');
            link.download = 'settlement_v9.png';
            link.href = canvas.toDataURL();
            link.click();
        });
    }
</script>

</body>
</html>
