<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Yona's Splitter V7</title>
<link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@600&family=Quicksand:wght@500;700&family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">
<script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
<style>
    :root {
        --bg-color: #FDFCF8;
        --card-bg: #FFFFFF;
        --primary: #B09B88;
        --accent: #D4A373;
        --text-main: #5A544F;
        --text-sub: #9C948B;
        --radius: 16px;
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

    body {
        font-family: 'Quicksand', 'Noto Sans TC', sans-serif;
        background-color: var(--bg-color);
        color: var(--text-main);
        margin: 0;
        padding: 20px;
        padding-bottom: 120px;
        max-width: 600px;
        margin: 0 auto;
    }

    h1 {
        font-family: 'Cormorant Garamond', serif;
        text-align: center;
        color: var(--primary);
        margin-bottom: 5px;
        font-size: 28px;
    }

    .card {
        background: var(--card-bg);
        border-radius: var(--radius);
        padding: 20px;
        margin-bottom: 15px;
        box-shadow: 0 4px 20px rgba(149, 133, 119, 0.08);
        border: 1px solid rgba(0,0,0,0.02);
    }

    /* æˆå“¡ç®¡ç†å€ */
    .setting-label { font-size: 13px; color: var(--text-sub); margin-bottom: 8px; display: block; font-weight: bold; }
    
    .member-list {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-bottom: 10px;
    }
    .member-tag {
        background: #F0F0F0;
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 14px;
        display: flex;
        align-items: center;
        gap: 6px;
        color: #555;
    }
    .btn-remove {
        background: #CCC; color: white; border-radius: 50%; width: 18px; height: 18px;
        display: flex; align-items: center; justify-content: center; font-size: 10px; cursor: pointer; border: none;
    }
    
    .add-row { display: flex; gap: 8px; }

    /* è¼¸å…¥å€ */
    input {
        width: 100%; padding: 12px; border: 1px solid #EEE; border-radius: 10px;
        font-size: 15px; background: #FAFAFA; color: var(--text-main); outline: none;
        font-family: inherit;
    }
    
    /* ä»˜æ¬¾äººæŒ‰éˆ• */
    .payer-selector {
        display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 10px;
    }
    .payer-btn {
        flex: 1; min-width: 80px; padding: 10px; border-radius: 10px; border: 1px solid #EEE; 
        background: white; color: var(--text-sub); cursor: pointer; text-align: center; font-size: 14px;
        transition: 0.2s;
    }
    .payer-btn.active {
        background: var(--primary); color: white; border-color: var(--primary); font-weight: bold;
        box-shadow: 0 4px 10px rgba(176,155,136,0.3);
    }

    .btn {
        width: 100%; padding: 12px; border: none; border-radius: 10px;
        background: #333; color: white; font-size: 16px; font-weight: bold; cursor: pointer; margin-top: 10px;
    }
    .btn.secondary { background: var(--accent); }

    /* æ¸…å–® */
    .expense-list { list-style: none; padding: 0; margin: 0; }
    .expense-item {
        padding: 15px 0; border-bottom: 1px dashed #EEE;
        display: flex; justify-content: space-between; align-items: center;
    }
    .item-info { flex: 1; }
    .item-title { font-weight: bold; font-size: 15px; margin-bottom: 4px; }
    .item-sub { font-size: 12px; color: #BBB; }
    .payer-badge { background: var(--primary); color: white; padding: 2px 6px; border-radius: 4px; margin-right: 5px; }

    .item-right { text-align: right; }
    .item-price { font-weight: bold; font-size: 16px; color: var(--text-main); }
    .btn-del { color: #DDD; background: none; border: none; font-size: 18px; cursor: pointer; padding: 5px; }

    /* å ±è¡¨ Modal */
    #report-modal {
        position: fixed; top: 0; left: 0; right: 0; bottom: 0;
        background: rgba(0,0,0,0.5); z-index: 200;
        display: none; align-items: center; justify-content: center; padding: 20px;
    }
    #receipt-paper {
        background: #FFF; width: 100%; max-width: 400px;
        padding: 30px 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        max-height: 85vh; overflow-y: auto;
        font-family: 'Courier Prime', 'Noto Sans TC', monospace;
        position: relative;
    }
    #receipt-paper::before {
        content: ""; position: absolute; top: -5px; left: 0; right: 0; height: 10px;
        background: radial-gradient(circle, transparent 5px, #fff 5px) repeat-x; background-size: 10px 10px;
    }

    .receipt-row { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 13px; line-height: 1.4; }
    .receipt-divider { border-bottom: 1px dashed #CCC; margin: 15px 0; }
    
    .settlement-block {
        background: #F9F9F9; padding: 15px; border-radius: 8px; margin-top: 15px;
    }
    .settlement-row {
        display: flex; justify-content: space-between; align-items: center;
        margin-bottom: 8px; font-size: 13px; border-bottom: 1px dotted #E0E0E0; padding-bottom: 4px;
    }
    .settlement-row:last-child { border-bottom: none; }
    .s-arrow { color: #AAA; font-size: 10px; margin: 0 5px; }
    .s-amount { font-weight: bold; color: var(--text-main); }

</style>
</head>
<body>

    <h1>Travel Splitter</h1>
    
    <div class="card">
        <label class="setting-label">ğŸ‘¥ æ—…ç¨‹æˆå“¡åå–® (æœ‰åå–®æ‰ç®—äººé ­)</label>
        <div class="member-list" id="memberTags">
            </div>
        <div class="add-row">
            <input type="text" id="newMemberName" placeholder="è¼¸å…¥åå­— (å¦‚: æˆ‘, è€å…¬, å°ç¾)" style="font-size:14px;">
            <button class="btn secondary" onclick="addMember()" style="width:auto; margin:0;">æ–°å¢æˆå“¡</button>
        </div>
        <div style="font-size:12px; color:#999; margin-top:5px; text-align:right;">
            ç›®å‰ç¸½äººæ•¸: <span id="totalCountDisplay" style="font-weight:bold; color:var(--primary);">0</span> äºº
        </div>
    </div>

    <div class="card">
        <label class="setting-label">ğŸ‘‡ èª°å…ˆä»˜çš„éŒ¢ï¼Ÿ (Payer)</label>
        <div class="payer-selector" id="payerButtons">
            <div style="font-size:12px; color:#bbb; padding:10px;">è«‹å…ˆæ–°å¢æˆå“¡...</div>
        </div>

        <div style="display:flex; gap:10px; margin-bottom:10px;">
            <input type="date" id="dateInput">
            <input type="time" id="timeInput">
        </div>
        
        <input type="text" id="itemName" placeholder="æ¶ˆè²»é …ç›® (å¦‚: æ™šé¤)" style="margin-bottom:10px;">
        <input type="number" id="priceInput" placeholder="é‡‘é¡ $" inputmode="numeric">
        
        <button class="btn" onclick="addExpense()">ï¼‹ è¨˜ä¸€ç­†</button>
    </div>

    <div class="card">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
            <h3 style="margin:0; font-size:14px; color:var(--text-sub);">æ¶ˆè²»æ˜ç´°</h3>
            <button onclick="showReport()" style="background:none; border:1px solid var(--primary); color:var(--primary); padding:6px 12px; border-radius:20px; cursor:pointer; font-size:12px; font-weight:bold;">
                ğŸ§¾ ç”¢å‡ºçµç®—è¡¨
            </button>
        </div>
        <ul class="expense-list" id="list">
            <li style="text-align:center; padding:20px; color:#ddd;">æš«ç„¡è³‡æ–™</li>
        </ul>
    </div>

    <div id="report-modal">
        <div id="receipt-paper">
            <div style="text-align:center; border-bottom:2px dashed #333; padding-bottom:15px; margin-bottom:15px;">
                <div style="font-size:20px; font-weight:bold;">Trip Expenses</div>
                <div style="font-size:12px; color:#888;" id="reportDate"></div>
                <div style="font-size:12px; color:#888; margin-top:5px;">Total Members: <span id="reportMemberCount">0</span></div>
            </div>

            <div id="report-list"></div>

            <div class="receipt-divider"></div>

            <div class="receipt-row">
                <span>Total Cost</span>
                <span id="report-total" style="font-weight:bold;">$0</span>
            </div>
            <div class="receipt-row">
                <span>Avg / Person</span>
                <span id="report-avg" style="color:var(--accent); font-weight:bold;">$0</span>
            </div>

            <div class="settlement-block">
                <div style="text-align:center; font-size:12px; margin-bottom:10px; font-weight:bold; color:#555;">SETTLEMENT (çµç®—å»ºè­°)</div>
                <div id="report-settlement"></div>
            </div>

            <div style="margin-top:20px; text-align:center;">
                <button class="btn" onclick="downloadReport()">â¬‡ï¸ ä¸‹è¼‰åœ–ç‰‡</button>
                <button class="btn" onclick="closeReport()" style="background:#ddd; color:#555; margin-top:5px;">é—œé–‰</button>
            </div>
        </div>
    </div>

<script>
    // è³‡æ–™
    let members = ['æˆ‘', 'è€å…¬']; // é è¨­åå–®
    let expenses = [];
    let currentPayer = '';

    // åˆå§‹åŒ–
    const dateInput = document.getElementById('dateInput');
    const timeInput = document.getElementById('timeInput');
    const now = new Date();
    dateInput.value = now.toISOString().split('T')[0];
    timeInput.value = now.toTimeString().slice(0, 5);

    renderMemberUI();

    // --- æˆå“¡ç®¡ç†é‚è¼¯ ---
    function renderMemberUI() {
        const tagContainer = document.getElementById('memberTags');
        const btnContainer = document.getElementById('payerButtons');
        
        tagContainer.innerHTML = '';
        btnContainer.innerHTML = '';

        members.forEach((name, index) => {
            // 1. åå–®æ¨™ç±¤
            const tag = document.createElement('div');
            tag.className = 'member-tag';
            tag.innerHTML = `${name} <button class="btn-remove" onclick="removeMember(${index})">Ã—</button>`;
            tagContainer.appendChild(tag);

            // 2. ä»˜æ¬¾æŒ‰éˆ•
            const btn = document.createElement('div');
            btn.className = `payer-btn ${currentPayer === name ? 'active' : ''}`;
            btn.textContent = name;
            btn.onclick = () => {
                currentPayer = name;
                renderMemberUI(); // æ›´æ–°æ¨£å¼
            };
            btnContainer.appendChild(btn);
        });

        document.getElementById('totalCountDisplay').textContent = members.length;

        // è‡ªå‹•é¸å–ç¬¬ä¸€å€‹äºº
        if (!members.includes(currentPayer) && members.length > 0) {
            currentPayer = members[0];
            setTimeout(renderMemberUI, 0);
        }
    }

    function addMember() {
        const input = document.getElementById('newMemberName');
        const name = input.value.trim();
        if (name && !members.includes(name)) {
            members.push(name);
            input.value = '';
            renderMemberUI();
        } else if (members.includes(name)) {
            alert('é€™å€‹åå­—å·²ç¶“æœ‰äº†å–”ï¼');
        }
    }

    function removeMember(index) {
        if (confirm(`ç¢ºå®šè¦ç§»é™¤ã€Œ${members[index]}ã€å—ï¼Ÿ(å¦‚æœä»–æœ‰ä»˜ééŒ¢ï¼Œå¸³ç›®æœƒä¿ç•™ï¼Œä½†äººæ•¸åˆ†æ¯æœƒè®Šå°‘å–”ï¼)`)) {
            members.splice(index, 1);
            renderMemberUI();
        }
    }

    // --- è¨˜å¸³é‚è¼¯ ---
    function addExpense() {
        const name = document.getElementById('itemName').value.trim();
        const price = parseInt(document.getElementById('priceInput').value);
        
        if (members.length === 0) { alert('è«‹å…ˆæ–°å¢æˆå“¡ï¼'); return; }
        if (!currentPayer) { alert('è«‹é¸æ“‡èª°ä»˜éŒ¢ï¼'); return; }
        if (!name || isNaN(price)) { alert('è«‹è¼¸å…¥é …ç›®å’Œé‡‘é¡'); return; }

        expenses.push({
            id: Date.now(),
            date: dateInput.value,
            time: timeInput.value,
            item: name,
            price: price,
            payer: currentPayer
        });

        document.getElementById('itemName').value = '';
        document.getElementById('priceInput').value = '';
        renderList();
    }

    function deleteExpense(id) {
        if(confirm('åˆªé™¤é€™ç­†ï¼Ÿ')) {
            expenses = expenses.filter(e => e.id !== id);
            renderList();
        }
    }

    function renderList() {
        const list = document.getElementById('list');
        list.innerHTML = '';
        
        expenses.sort((a, b) => b.id - a.id).forEach(e => {
            const li = document.createElement('li');
            li.className = 'expense-item';
            const d = new Date(e.date);
            li.innerHTML = `
                <div class="item-info">
                    <div class="item-title">${e.item}</div>
                    <div class="item-sub">
                        <span class="payer-badge">${e.payer}</span>
                        ${d.getMonth()+1}/${d.getDate()} ${e.time}
                    </div>
                </div>
                <div class="item-right">
                    <div class="item-price">$${e.price.toLocaleString()}</div>
                    <button class="btn-del" onclick="deleteExpense(${e.id})">ğŸ—‘ï¸</button>
                </div>
            `;
            list.appendChild(li);
        });
        
        if(expenses.length === 0) list.innerHTML = '<li style="text-align:center; padding:20px; color:#ddd;">æš«ç„¡è³‡æ–™</li>';
    }

    // --- æ ¸å¿ƒï¼šçµç®—é‚è¼¯ ---
    function showReport() {
        const modal = document.getElementById('report-modal');
        const reportList = document.getElementById('report-list');
        const reportSettlement = document.getElementById('report-settlement');
        
        document.getElementById('reportDate').textContent = new Date().toLocaleString();
        document.getElementById('reportMemberCount').textContent = members.length;
        reportList.innerHTML = '';
        
        // 1. çµ±è¨ˆç¸½èŠ±è²» & æ¯å€‹äººä»˜äº†å¤šå°‘
        let totalCost = 0;
        let paidMap = {}; 
        
        // åˆå§‹åŒ–æ‰€æœ‰äººä»˜è²»ç‚º 0
        members.forEach(m => paidMap[m] = 0);
        
        // ä¾åºè¨ˆç®—
        const sortedExpenses = [...expenses].sort((a, b) => a.id - b.id);
        sortedExpenses.forEach(e => {
            totalCost += e.price;
            
            // å¦‚æœä»˜éŒ¢çš„äººå·²ç¶“ä¸åœ¨åå–®è£¡(è¢«åˆªé™¤)ï¼Œæˆ‘å€‘é‚„æ˜¯è¦è¨˜ä¸Šä¸€ç­†ï¼Œåªæ˜¯ç„¡æ³•åƒèˆ‡åˆ†æ¯
            if (paidMap[e.payer] === undefined) paidMap[e.payer] = 0;
            paidMap[e.payer] += e.price;

            const row = document.createElement('div');
            row.className = 'receipt-row';
            row.innerHTML = `
                <div style="flex:2;">${e.item} <span style="font-size:10px; color:#999;">(${e.payer})</span></div>
                <div style="flex:1; text-align:right;">$${e.price.toLocaleString()}</div>
            `;
            reportList.appendChild(row);
        });

        // 2. è¨ˆç®—å¹³å‡ (åˆ†æ¯å°±æ˜¯åå–®ä¸Šçš„äººæ•¸)
        // æ•¸å­¸å…¬å¼ï¼šç¸½èŠ±è²» / åå–®äººæ•¸
        const memberCount = members.length;
        const avg = memberCount > 0 ? Math.ceil(totalCost / memberCount) : 0;

        document.getElementById('report-total').textContent = `$${totalCost.toLocaleString()}`;
        document.getElementById('report-avg').textContent = `$${avg.toLocaleString()}`;

        // 3. è¨ˆç®—æ¯å€‹äººçš„é¤˜é¡ (Balance)
        // é¤˜é¡ = ä»–ä»˜çš„éŒ¢ - ä»–è©²ä»˜çš„å¹³å‡å€¼
        let balances = [];
        
        members.forEach(name => {
            const paid = paidMap[name] || 0;
            const balance = paid - avg;
            balances.push({ name: name, balance: balance });
        });

        // 4. é…å° (Debtors vs Creditors)
        let debtors = balances.filter(p => p.balance < 0).sort((a,b) => a.balance - b.balance);
        let creditors = balances.filter(p => p.balance > 0).sort((a,b) => b.balance - a.balance);

        let html = '';
        let i = 0, j = 0;

        while (i < debtors.length && j < creditors.length) {
            let debtor = debtors[i];
            let creditor = creditors[j];
            let debt = Math.abs(debtor.balance);
            let credit = creditor.balance;
            let amount = Math.min(debt, credit);

            if (amount > 0) {
                html += `
                    <div class="settlement-row">
                        <span>${debtor.name} <span class="s-arrow">â” çµ¦ â”</span> ${creditor.name}</span>
                        <span class="s-amount">$${Math.ceil(amount).toLocaleString()}</span>
                    </div>
                `;
            }

            debtor.balance += amount;
            creditor.balance -= amount;

            if (Math.abs(debtor.balance) < 1) i++; // çµæ¸…æ›ä¸‹ä¸€ä½
            if (creditor.balance < 1) j++; // çµæ¸…æ›ä¸‹ä¸€ä½
        }

        reportSettlement.innerHTML = html || '<div style="text-align:center; color:#999;">å¸³å‹™å¹³è¡¡ (æ¯äººéƒ½ä»˜å¾—å‰›å‰›å¥½)</div>';
        
        modal.style.display = 'flex';
    }

    function closeReport() {
        document.getElementById('report-modal').style.display = 'none';
    }

    function downloadReport() {
        const paper = document.getElementById('receipt-paper');
        html2canvas(paper, { scale: 2 }).then(canvas => {
            const link = document.createElement('a');
            link.download = 'travel-settlement.png';
            link.href = canvas.toDataURL();
            link.click();
        });
    }
</script>

</body>
</html>
